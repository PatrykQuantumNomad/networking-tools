# Milestone v1.4: JSON Output Mode

**Status:** SHIPPED 2026-02-14
**Phases:** 23-27
**Total Plans:** 10

## Overview

Added structured JSON output to all 46 use-case scripts via a new `-j`/`--json` flag backed by `lib/json.sh`, enabling piping into `jq` and downstream automation. JSON envelope format: `{"meta": {tool, script, target, timestamp, mode}, "results": [...], "summary": {total, succeeded, failed}}`.

## Phases

### Phase 23: JSON Library & Flag Integration

**Goal**: Users can pass `-j`/`--json` to any script and the library infrastructure correctly activates JSON mode with clean stdout separation
**Depends on**: Phase 22 (v1.3 complete)
**Plans**: 1 plan

Plans:
- [x] 23-01: Create lib/json.sh, wire -j flag into args.sh, add JSON branches to output.sh

**Details:**
- Created `scripts/lib/json.sh` with 5 public functions: json_is_active, json_set_meta, json_add_result, json_add_example, json_finalize
- fd3 redirect pattern: `exec 3>&1` saves stdout, `exec 1>&2` redirects script output to stderr, JSON written to fd3
- Lazy jq dependency: `_json_check_jq` at source time, `_json_require_jq` only when `-j` is parsed
- 4-path `run_or_show` in output.sh: show+text, execute+text, show+JSON, execute+JSON
- Suppressed safety_banner and confirm_execute in JSON mode

### Phase 24: Library Unit Tests

**Goal**: The JSON library and flag parsing are proven correct via automated tests before any scripts are modified
**Depends on**: Phase 23
**Plans**: 2 plans

Plans:
- [x] 24-01: Create tests/lib-json.bats with unit tests for all json.sh functions
- [x] 24-02: Add -j flag tests to lib-args.bats and JSON-mode tests to lib-output.bats

**Details:**
- 19 BATS unit tests for json.sh covering all 5 public functions and _json_require_jq internal
- Subprocess fd3 isolation pattern via `_run_json_subprocess` helper
- 8 BATS tests for -j flag parsing in lib-args.bats with `_run_parse_json` subprocess helper
- 2 BATS tests for safety_banner and confirm_execute JSON-mode suppression
- Total: 29 new tests, suite at 295

### Phase 25: Script Migration

**Goal**: All 46 use-case scripts produce structured JSON output when invoked with `-j`
**Depends on**: Phase 24
**Plans**: 4 plans

Plans:
- [x] 25-01: Extend json_set_meta with category + migrate 11 Group A scripts (pure run_or_show)
- [x] 25-02: Migrate 11 Group C scripts: password-cracker + exploitation tools (pure info+echo)
- [x] 25-03: Migrate 10 Group C scripts: network-analysis + forensics + netcat (pure info+echo)
- [x] 25-04: Migrate 14 Group B scripts: mixed run_or_show + info+echo

**Details:**
- 2-line migration pattern: json_set_meta after TARGET, json_finalize before demo block
- json_add_example for bare info+echo examples not captured by run_or_show
- NC_VARIANT branching: json_add_example inside each conditional branch for variant-specific commands
- Category taxonomy: network-analysis, network-scanner, web-scanner, sql-injection, password-cracker, exploitation, forensics
- All 46 scripts produce valid JSON with exactly 10 results each

### Phase 26: Integration Tests

**Goal**: Automated tests prove every script's JSON output is valid and structurally correct
**Depends on**: Phase 25
**Plans**: 1 plan

Plans:
- [x] 26-01: Create intg-json-output.bats with dynamic JSON output tests for all 46 scripts

**Details:**
- Dynamic test registration discovering all use-case scripts via find
- bash -c wrapper for fd3 JSON capture (BATS run mixes stdout+stderr)
- 9 structural assertions per script: valid JSON, envelope keys, meta fields, results array, summary fields
- diagnose-latency.sh excluded on macOS non-root (sudo requirement)
- 47 new tests, suite at 342

### Phase 27: Documentation

**Goal**: Users can discover and understand the `-j`/`--json` flag through help text and script headers
**Depends on**: Phase 25
**Plans**: 2 plans

Plans:
- [x] 27-01: Update @usage headers and show_help() for all 46 use-case scripts
- [x] 27-02: Add BATS verification tests for DOC-01 and DOC-02

**Details:**
- Updated @usage metadata header in all 46 scripts to include `[-j|--json]`
- 3 show_help() patterns: Pattern A (insert into Options), Pattern B standard (3-flag Flags section), Pattern B with -v/-q (5-flag Flags section)
- 93 DOC verification tests (46 DOC-01 help text + 46 DOC-02 @usage header + 1 meta)
- Final suite: 435 tests, 0 failures

---

## Milestone Summary

**Key Decisions:**
- fd3 for JSON output: exec 3>&1 saves stdout, exec 1>&2 redirects to stderr (keeps JSON clean on stdout)
- Lazy jq dependency: check at source time, require only when -j parsed (scripts without -j never need jq)
- Color vars reset at parse time: colors.sh evaluates at source, -j resets at runtime
- Category parameter optional (empty string default) for backward compatibility
- json_add_example for bare info+echo examples (run_or_show captured automatically by library)
- bash -c wrapper for BATS fd3 JSON capture (run mixes stdout+stderr; bash -c with 2>/dev/null isolates JSON)
- No macOS exclusion needed for DOC tests (--help and header parsing don't require sudo)

**Issues Resolved:**
- BASH_SOURCE[1] unbound variable under set -u in bash -c invocations (fixed with fallback)
- BATS stdout/stderr capture for fd3 JSON output (fixed with bash -c wrapper)
- awk temp-file approach stripped executable permissions on 35 scripts (fixed with chmod +x)

**Issues Deferred:**
- Structured tool-specific output parsing (nmap XML, tshark JSON, nikto JSON) deferred to future milestone
- --jq EXPR filter flag deferred to future milestone
- NDJSON streaming mode for long-running commands deferred to future milestone

**Technical Debt Incurred:**
- None significant -- all patterns are clean and tested

---

_For current project status, see .planning/ROADMAP.md_
