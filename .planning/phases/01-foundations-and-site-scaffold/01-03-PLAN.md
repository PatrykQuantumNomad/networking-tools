---
phase: 01-foundations-and-site-scaffold
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - .github/workflows/deploy-site.yml
autonomous: true

must_haves:
  truths:
    - "Pushing to main triggers the GitHub Actions workflow"
    - "The workflow builds the Astro site from the site/ subdirectory"
    - "The workflow deploys to GitHub Pages using actions-based deployment (bypassing Jekyll)"
    - "workflow_dispatch allows manual rebuilds"
  artifacts:
    - path: ".github/workflows/deploy-site.yml"
      provides: "GitHub Actions workflow for building and deploying the Astro site to GitHub Pages"
      contains: "withastro/action@v5"
  key_links:
    - from: ".github/workflows/deploy-site.yml"
      to: "site/"
      via: "withastro/action path input"
      pattern: "path: ./site"
    - from: ".github/workflows/deploy-site.yml"
      to: "GitHub Pages"
      via: "actions/deploy-pages@v4"
      pattern: "deploy-pages@v4"
---

<objective>
Create the GitHub Actions workflow that builds and deploys the Astro site to GitHub Pages on every push to main.

Purpose: Automated deployment ensures the site is always up-to-date. Using withastro/action@v5 + actions/deploy-pages@v4 bypasses Jekyll processing (PITFALL-2), preserving the _astro/ directory.
Output: A single workflow file at .github/workflows/deploy-site.yml.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundations-and-site-scaffold/01-RESEARCH.md
@.planning/phases/01-foundations-and-site-scaffold/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions deploy workflow for Astro site</name>
  <files>.github/workflows/deploy-site.yml</files>
  <action>
Create the directory `.github/workflows/` and the workflow file `deploy-site.yml` with the following content:

```yaml
name: Deploy site to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Build Astro site
        uses: withastro/action@v5
        with:
          path: ./site
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

Key design decisions from research:
- **No path filter on trigger**: Rebuild on every push to main. Astro builds are fast (seconds) and path-filtering risks stale deployments (PITFALL-13).
- **`cancel-in-progress: false`**: Do not cancel in-progress deployments. This prevents partial deployments.
- **`path: ./site`**: Tells withastro/action where the Astro project lives (subdirectory, not root).
- **`actions/checkout@v5`**: Latest stable checkout action.
- **`withastro/action@v5`** (5.1.0): Auto-detects package manager from lockfile, defaults to Node 22.
- **`actions/deploy-pages@v4`**: Official GitHub Pages deployment action. Actions-based deployment bypasses Jekyll entirely (PITFALL-2) -- no .nojekyll file needed.
- **`workflow_dispatch`**: Allows manual rebuilds from the GitHub Actions UI.
- **Permissions**: `pages: write` and `id-token: write` are required for GitHub Pages deployment. `contents: read` for checkout.

Do NOT add any of these anti-patterns:
- Path filtering (`paths: ['site/**']`) -- risks stale deploys
- `.nojekyll` file creation step -- not needed with Actions-based deployment
- Custom Node.js setup step -- withastro/action handles this
- npm install step -- withastro/action handles this
  </action>
  <verify>
```bash
# Verify the workflow file exists and has correct structure
cat .github/workflows/deploy-site.yml

# Verify key elements
grep "withastro/action@v5" .github/workflows/deploy-site.yml
grep "path: ./site" .github/workflows/deploy-site.yml
grep "deploy-pages@v4" .github/workflows/deploy-site.yml
grep "workflow_dispatch" .github/workflows/deploy-site.yml

# Validate YAML syntax (if yq or python available)
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-site.yml'))" 2>/dev/null && echo "YAML valid" || echo "YAML check skipped"
```
  </verify>
  <done>
- `.github/workflows/deploy-site.yml` exists with correct YAML
- Workflow triggers on push to main and workflow_dispatch
- Build job uses `withastro/action@v5` with `path: ./site`
- Deploy job uses `actions/deploy-pages@v4`
- Permissions set for pages write and id-token write
- No path filtering on trigger
- No `.nojekyll` step (not needed with Actions deploy)
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy-site.yml` exists
2. `grep "withastro/action@v5" .github/workflows/deploy-site.yml` matches
3. `grep "path: ./site" .github/workflows/deploy-site.yml` matches
4. `grep "deploy-pages@v4" .github/workflows/deploy-site.yml` matches
5. YAML is syntactically valid
6. No path filter on push trigger
7. workflow_dispatch is present for manual rebuilds

Note: Full deployment verification requires pushing to main and enabling GitHub Pages in the repository settings (Settings -> Pages -> Source: GitHub Actions). This will be verified after the push.
</verification>

<success_criteria>
- Workflow file exists at .github/workflows/deploy-site.yml
- Workflow builds the Astro site from site/ subdirectory
- Workflow deploys to GitHub Pages via actions/deploy-pages
- No anti-patterns present (path filtering, .nojekyll, custom Node setup)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundations-and-site-scaffold/01-03-SUMMARY.md`
</output>
