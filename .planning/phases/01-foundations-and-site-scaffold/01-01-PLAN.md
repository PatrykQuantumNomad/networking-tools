---
phase: 01-foundations-and-site-scaffold
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/common.sh
autonomous: true

must_haves:
  truths:
    - "report_pass, report_fail, report_warn, report_skip produce colored [PASS]/[FAIL]/[WARN]/[SKIP] output"
    - "report_section produces a cyan section header with === delimiters"
    - "run_check executes a command with timeout and reports pass/fail automatically"
    - "run_check works on macOS without GNU coreutils timeout installed"
    - "Existing functions (info, success, warn, error, require_cmd, etc.) still work unchanged"
  artifacts:
    - path: "scripts/common.sh"
      provides: "Diagnostic report functions for Pattern B scripts"
      contains: "report_pass"
  key_links:
    - from: "scripts/common.sh"
      to: "future scripts/diagnostics/*.sh"
      via: "source common.sh"
      pattern: "report_(pass|fail|warn|skip|section)|run_check"
---

<objective>
Add diagnostic report functions to common.sh: report_pass, report_fail, report_warn, report_skip, report_section, and run_check with a portable timeout wrapper.

Purpose: Phase 3 diagnostic scripts need structured pass/fail output. These functions must exist before any diagnostic script can be written.
Output: Extended scripts/common.sh with 8 new functions (report_pass, report_fail, report_warn, report_skip, report_section, _run_with_timeout, run_check) appended after the existing code.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundations-and-site-scaffold/01-RESEARCH.md
@scripts/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diagnostic report functions and run_check to common.sh</name>
  <files>scripts/common.sh</files>
  <action>
Append the following functions to the end of `scripts/common.sh` (before the PROJECT_ROOT line, or after it -- keep PROJECT_ROOT as the last non-function line if that reads better, but the key requirement is that the functions are added and the existing code is not modified).

Add a section comment and the following functions:

```bash
# --- Diagnostic Report Functions ---
# Used by Pattern B (diagnostic scripts), not Pattern A (educational examples)

report_pass()    { echo -e "${GREEN}[PASS]${NC} $*"; }
report_fail()    { echo -e "${RED}[FAIL]${NC} $*"; }
report_warn()    { echo -e "${YELLOW}[WARN]${NC} $*"; }
report_skip()    { echo -e "${CYAN}[SKIP]${NC} $*"; }

report_section() { echo -e "\n${CYAN}=== $* ===${NC}\n"; }

# Portable timeout wrapper (macOS lacks GNU timeout)
_run_with_timeout() {
    local seconds="$1"
    shift
    if command -v timeout &>/dev/null; then
        timeout "$seconds" "$@"
    else
        # POSIX fallback: run in background, kill after timeout
        "$@" &
        local pid=$!
        ( sleep "$seconds" && kill "$pid" 2>/dev/null ) &
        local watchdog=$!
        wait "$pid" 2>/dev/null
        local exit_code=$?
        kill "$watchdog" 2>/dev/null
        wait "$watchdog" 2>/dev/null
        return $exit_code
    fi
}

# Execute a command with timeout and report pass/fail
# Usage: run_check "Description of check" command arg1 arg2
run_check() {
    local description="$1"
    shift
    local output
    if output=$(_run_with_timeout 10 "$@" 2>&1); then
        report_pass "$description"
        echo "$output" | sed 's/^/   /'
    else
        local exit_code=$?
        if [[ $exit_code -eq 124 ]]; then
            report_warn "$description (timed out)"
        else
            report_fail "$description"
        fi
        [[ -n "$output" ]] && echo "$output" | sed 's/^/   /'
    fi
}
```

Keep the existing `PROJECT_ROOT` line. Do not modify any existing functions. The new functions extend the file -- they do not replace anything.

Important implementation notes from research:
- Colors (GREEN, RED, YELLOW, CYAN, NC) are already defined at the top of common.sh -- reuse them.
- The `_run_with_timeout` function has a leading underscore to indicate it is internal (not called directly by scripts).
- The POSIX fallback for timeout uses background process + watchdog kill pattern. This is necessary because macOS does not ship GNU `timeout`.
- `run_check` defaults to a 10-second timeout. This is adequate for diagnostic checks (DNS lookups, port checks, HTTP requests).
  </action>
  <verify>
Run a quick smoke test to confirm all new functions work:

```bash
# Source common.sh and call each new function
bash -c '
  source scripts/common.sh
  report_pass "test pass"
  report_fail "test fail"
  report_warn "test warn"
  report_skip "test skip"
  report_section "Test Section"
  run_check "echo works" echo "hello"
  run_check "false fails" false
'
```

Expected: colored output showing [PASS], [FAIL], [WARN], [SKIP], section header, and run_check producing [PASS] for echo and [FAIL] for false.

Also verify existing functions still work:
```bash
bash -c 'source scripts/common.sh && info "test" && success "test" && warn "test" && error "test"'
```
  </verify>
  <done>
- `report_pass "msg"` prints green [PASS] msg
- `report_fail "msg"` prints red [FAIL] msg
- `report_warn "msg"` prints yellow [WARN] msg
- `report_skip "msg"` prints cyan [SKIP] msg
- `report_section "title"` prints cyan === title === with surrounding blank lines
- `run_check "desc" cmd args` runs cmd with 10s timeout, reports [PASS] on success, [FAIL] on failure, [WARN] on timeout
- All existing common.sh functions remain unchanged and functional
  </done>
</task>

</tasks>

<verification>
1. `bash -c 'source scripts/common.sh && report_pass "works"'` prints green [PASS] output
2. `bash -c 'source scripts/common.sh && run_check "echo test" echo hello'` prints [PASS] with indented output
3. `bash -c 'source scripts/common.sh && run_check "should fail" false'` prints [FAIL]
4. `bash -c 'source scripts/common.sh && report_section "DNS Resolution"'` prints cyan section header
5. Existing scripts still work: `bash scripts/check-tools.sh` runs without error
6. `grep -c 'report_pass\|report_fail\|report_warn\|report_skip\|report_section\|run_check' scripts/common.sh` returns 8 (6 functions + run_check usage of report_pass/fail)
</verification>

<success_criteria>
- scripts/common.sh contains report_pass, report_fail, report_warn, report_skip, report_section, _run_with_timeout, and run_check functions
- All new functions produce colored terminal output
- run_check works on macOS without GNU coreutils timeout
- Existing common.sh functions (info, success, warn, error, require_root, check_cmd, require_cmd, require_target, safety_banner, is_interactive) remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundations-and-site-scaffold/01-01-SUMMARY.md`
</output>
