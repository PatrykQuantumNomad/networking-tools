---
phase: 13-library-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - tests/test-library-loads.sh
  - scripts/lib/strict.sh
  - scripts/lib/colors.sh
  - scripts/lib/logging.sh
  - scripts/lib/cleanup.sh
  - scripts/common.sh
autonomous: true

must_haves:
  truths:
    - "A smoke test script verifies all expected functions are defined after sourcing common.sh"
    - "Running nmap/examples.sh produces identical visible output to before the refactor"
    - "Running a diagnostic script (dns-report.sh) produces identical visible output to before the refactor"
    - "VERBOSE=1 adds timestamps and shows debug messages"
    - "Piping any script through cat produces zero ANSI escape codes"
    - "An unhandled `false` in a sourced script prints a stack trace to stderr"
    - "A temp file created via make_temp() is gone after the script exits"
  artifacts:
    - path: "tests/test-library-loads.sh"
      provides: "Smoke test verifying all functions load correctly"
      contains: "declare -F"
  key_links:
    - from: "tests/test-library-loads.sh"
      to: "scripts/common.sh"
      via: "source statement"
      pattern: "source.*common.sh"
---

<objective>
Verify backward compatibility of the new library infrastructure by running a comprehensive smoke test and validating all 5 success criteria from the phase definition.

Purpose: The library split must not break any existing script. This plan catches regressions before they propagate to later phases.

Output: A passing smoke test script and verified backward compatibility across representative scripts.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-library-infrastructure/13-RESEARCH.md
@.planning/phases/13-library-infrastructure/13-01-SUMMARY.md
@scripts/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoke test and verify all functions load</name>
  <files>
    tests/test-library-loads.sh
  </files>
  <action>
Create `tests/test-library-loads.sh` that validates the library loaded correctly. The test script:

1. Source common.sh: `source "$(dirname "$0")/../scripts/common.sh"`
2. Check that ALL expected functions are defined via `declare -F`. The complete list of functions that MUST exist after sourcing:
   - From logging.sh: `info`, `success`, `warn`, `error`, `debug`
   - From validation.sh: `require_root`, `check_cmd`, `require_cmd`, `require_target`
   - From cleanup.sh: `make_temp`, `register_cleanup`, `retry_with_backoff`
   - From output.sh: `safety_banner`, `is_interactive`
   - From diagnostic.sh: `report_pass`, `report_fail`, `report_warn`, `report_skip`, `report_section`, `run_check`
   - From nc_detect.sh: `detect_nc_variant`
3. Check that internal variables exist: `_STRICT_LOADED`, `_COLORS_LOADED`, `_LOGGING_LOADED`, `_VALIDATION_LOADED`, `_CLEANUP_LOADED`, `_OUTPUT_LOADED`, `_DIAGNOSTIC_LOADED`, `_NC_DETECT_LOADED`, `_COMMON_LOADED`
4. Check that `PROJECT_ROOT` is set and points to a directory containing a `Makefile`
5. Check that color variables are defined (RED, GREEN, YELLOW, BLUE, CYAN, NC) — they may be empty strings if NO_COLOR is set, but they must be declared
6. Report pass/fail for each check, exit 1 if any failed

Make the script executable. Run it from the project root and confirm all checks pass.

If any check fails, debug the issue in the relevant lib module and fix it before proceeding.
  </action>
  <verify>
Run: `bash tests/test-library-loads.sh` from the project root — should print all PASS lines and exit 0
Run: `bash tests/test-library-loads.sh; echo "exit: $?"` — should show `exit: 0`
  </verify>
  <done>
Smoke test passes with all functions defined, all source guards set, PROJECT_ROOT correct, and color variables declared.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate all 5 phase success criteria</name>
  <files>
    scripts/lib/strict.sh
    scripts/lib/colors.sh
    scripts/lib/logging.sh
    scripts/lib/cleanup.sh
    scripts/common.sh
  </files>
  <action>
Systematically verify each of the 5 phase success criteria. Fix any issues found.

**SC1: Identical output (backward compatibility)**
- Run `bash scripts/nmap/examples.sh scanme.nmap.org < /dev/null 2>/dev/null | head -20` and confirm it produces the expected educational output (numbered examples with info messages)
- Run `bash scripts/check-tools.sh 2>/dev/null | head -10` and confirm it produces tool check output
- Run `bash scripts/diagnostics/dns-report.sh 2>/dev/null | head -10` (if it can run without special setup) — or at minimum confirm it sources common.sh without error: `bash -c 'source scripts/common.sh && echo OK'`
- Run at least one use-case script: `bash scripts/nmap/discover-live-hosts.sh 2>/dev/null < /dev/null | head -10`

**SC2: Stack trace on unhandled error**
- Create a temp test script that sources common.sh and calls `false` inside a function:
  ```bash
  #!/usr/bin/env bash
  source scripts/common.sh
  my_func() { false; }
  my_func
  ```
- Run it and confirm stderr contains "[ERROR] Command failed" and "at my_func()" stack trace entries
- Confirm the script exits with non-zero status

**SC3: VERBOSE mode**
- Run `VERBOSE=1 bash scripts/nmap/examples.sh scanme.nmap.org < /dev/null 2>/dev/null | head -5`
- Confirm output lines contain timestamps in HH:MM:SS format
- Run without VERBOSE and confirm NO timestamps appear
- Run `LOG_LEVEL=debug bash -c 'source scripts/common.sh && debug "test message"'` and confirm debug message appears
- Run `bash -c 'source scripts/common.sh && debug "test message"'` and confirm debug message does NOT appear (default LOG_LEVEL=info)

**SC4: No ANSI in pipes**
- Run: `bash scripts/nmap/examples.sh scanme.nmap.org < /dev/null 2>/dev/null | cat | grep -cP '\033\[' || echo "0"`
- Confirm result is 0 (zero ANSI escape sequences)
- This works because piping through cat means stdout is not a terminal, so colors.sh sets all color variables to empty strings

**SC5: Temp file cleanup**
- Create a temp test script:
  ```bash
  #!/usr/bin/env bash
  source scripts/common.sh
  tmpfile=$(make_temp)
  echo "test" > "$tmpfile"
  echo "TMPPATH:$tmpfile"
  ```
- Run it, capture the temp path from output, check that the file no longer exists after the script exits
- Also test make_temp with "dir" argument

If ANY criterion fails, diagnose the root cause and fix the relevant lib module. The files_modified list includes all modules that might need fixes. Only modify files that actually need changes.
  </action>
  <verify>
All 5 success criteria pass:
1. `bash scripts/nmap/examples.sh scanme.nmap.org < /dev/null 2>/dev/null | head -5` produces educational output
2. Stack trace test shows "[ERROR] Command failed" on stderr
3. `VERBOSE=1` shows timestamps; without it, no timestamps
4. Piped output has zero ANSI escape codes
5. make_temp() files are cleaned up after script exit
  </verify>
  <done>
All 5 phase success criteria verified. Any regressions found during verification have been fixed. The library infrastructure is proven backward-compatible and all new features (strict mode, stack traces, logging levels, color suppression, temp cleanup) work correctly.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `bash tests/test-library-loads.sh` exits 0
2. Representative scripts produce expected output
3. Stack trace appears on unhandled error
4. VERBOSE mode adds timestamps
5. Piped output is ANSI-free
6. Temp files auto-clean on exit
</verification>

<success_criteria>
- Smoke test script passes all checks
- All 5 phase success criteria from ROADMAP.md are verified
- No regressions in existing script behavior
- New capabilities (debug, make_temp, retry_with_backoff, stack traces) work as specified
</success_criteria>

<output>
After completion, create `.planning/phases/13-library-infrastructure/13-02-SUMMARY.md`
</output>
