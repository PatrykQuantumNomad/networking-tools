---
phase: 28-safety-architecture
plan: 02
type: execute
wave: 2
depends_on:
  - 28-01
files_modified:
  - .claude/hooks/netsec-health.sh
  - .claude/skills/netsec-health/SKILL.md
autonomous: false
requirements:
  - SAFE-05

must_haves:
  truths:
    - "Running the health-check script prints a checklist showing pass/fail for each safety component"
    - "Health check detects when a hook file is missing or not executable"
    - "Health check detects when hooks are not registered in settings.json"
    - "Health check detects when scope file is missing and offers to create one"
    - "Health check detects when .pentest/ directory is not writable or not gitignored"
    - "Health check works both as a standalone bash script and via Claude Code skill invocation"
  artifacts:
    - path: ".claude/hooks/netsec-health.sh"
      provides: "Standalone health-check script with pass/fail checklist and guided repair"
      min_lines: 80
    - path: ".claude/skills/netsec-health/SKILL.md"
      provides: "Claude Code skill slash command for health check"
      min_lines: 15
  key_links:
    - from: ".claude/hooks/netsec-health.sh"
      to: ".claude/settings.json"
      via: "Reads settings.json to verify hook registrations"
      pattern: "settings\\.json"
    - from: ".claude/hooks/netsec-health.sh"
      to: ".claude/hooks/netsec-pretool.sh"
      via: "Checks file existence and executable permission"
      pattern: "netsec-pretool"
    - from: ".claude/hooks/netsec-health.sh"
      to: ".pentest/scope.json"
      via: "Checks scope file exists and is valid JSON"
      pattern: "scope\\.json"
    - from: ".claude/skills/netsec-health/SKILL.md"
      to: ".claude/hooks/netsec-health.sh"
      via: "Skill instructions tell Claude to run the health-check script"
      pattern: "netsec-health"
---

<objective>
Create a health-check system that verifies all safety hooks are installed, registered, and functioning correctly, available both as a standalone bash script and a Claude Code skill.

Purpose: Users need a way to confirm the safety architecture is working before relying on it. The health check is the diagnostic entry point for troubleshooting hook issues.

Output: Executable health-check bash script and a Claude Code skill SKILL.md for slash command access.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-safety-architecture/28-01-SUMMARY.md
@.planning/phases/28-safety-architecture/28-RESEARCH.md
@.claude/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health-check bash script with guided repair</name>
  <files>.claude/hooks/netsec-health.sh</files>
  <action>
Create `.claude/hooks/netsec-health.sh` (executable) implementing a comprehensive health check for the safety architecture.

**Script structure:**

Header with `#!/usr/bin/env bash` and description comment. Accept optional `-j` flag for JSON output (for future skill integration, but primarily human-readable output).

**Helper function `check()`:**
```bash
PASS=0
FAIL=0
CHECKS=()

check() {
    local label="$1" result="$2"
    if [[ "$result" == "true" ]]; then
        echo "  [pass] $label"
        ((PASS++))
        CHECKS+=("{\"label\":\"$label\",\"status\":\"pass\"}")
    else
        echo "  [FAIL] $label"
        ((FAIL++))
        CHECKS+=("{\"label\":\"$label\",\"status\":\"fail\"}")
    fi
}
```

**Determine project root:**
Use `CLAUDE_PROJECT_DIR` if set, else `git rev-parse --show-toplevel`, else current directory.

**Check categories (print header for each section):**

1. **Hook Files** (section header: "Hook Files")
   - `check "PreToolUse hook file exists (.claude/hooks/netsec-pretool.sh)"` — test with `-f`
   - `check "PostToolUse hook file exists (.claude/hooks/netsec-posttool.sh)"` — test with `-f`
   - `check "PreToolUse hook is executable"` — test with `-x`
   - `check "PostToolUse hook is executable"` — test with `-x`

2. **Hook Registration** (section header: "Hook Registration")
   - `check "PreToolUse hook registered in settings.json"` — use `jq -e '.hooks.PreToolUse' .claude/settings.json &>/dev/null`
   - `check "PostToolUse hook registered in settings.json"` — use `jq -e '.hooks.PostToolUse' .claude/settings.json &>/dev/null`

3. **Scope Configuration** (section header: "Scope Configuration")
   - `check "Scope file exists (.pentest/scope.json)"` — test with `-f`
   - `check "Scope file is valid JSON with targets array"` — use `jq -e '.targets | type == "array"' .pentest/scope.json &>/dev/null`
   - If scope file exists, also display current targets: `echo "  Targets: $(jq -r '.targets | join(", ")' .pentest/scope.json 2>/dev/null)"`

4. **Audit Infrastructure** (section header: "Audit Infrastructure")
   - `check "Audit directory exists (.pentest/)"` — test with `-d`
   - `check "Audit directory is writable"` — test with `-w`
   - `check ".pentest/ is gitignored"` — use `git check-ignore -q .pentest/ 2>/dev/null`
   - If audit files exist, display count: `echo "  Audit files: $(ls .pentest/audit-*.jsonl 2>/dev/null | wc -l | tr -d ' ')"`

5. **Dependencies** (section header: "Dependencies")
   - `check "jq is installed"` — use `command -v jq &>/dev/null`
   - `check "bash version >= 4.0 (associative arrays)"` — check `${BASH_VERSINFO[0]}` >= 4

**Summary line:**
```
echo ""
echo "=== $PASS passed, $FAIL failed ==="
```

**Guided repair (interactive mode only — check `[[ -t 0 ]]`):**
If there are failures, offer to fix each fixable issue. Only offer when running in a terminal (not piped).

Fixable issues and their repairs:
- Hook files not executable: `chmod +x .claude/hooks/netsec-pretool.sh .claude/hooks/netsec-posttool.sh`
- Scope file missing: Offer to create `.pentest/scope.json` with default lab targets `{"targets":["localhost","127.0.0.1"],"ports":[],"notes":"Default scope - add your targets here"}`
- .pentest/ directory missing: `mkdir -p .pentest`
- .pentest/ not gitignored: Offer to append to .gitignore

For each repair, prompt: `read -rp "Fix: <description>? [y/N] " answer` and only apply if user confirms.

**Exit code:** Exit 0 if all checks pass, exit 1 if any check fails.

Make executable with `chmod +x`.
  </action>
  <verify>
```bash
# Test 1: Run health check (should show pass/fail for each item)
bash .claude/hooks/netsec-health.sh
# Expected: Checklist output with section headers, pass/fail per item, summary line

# Test 2: Verify exit code reflects status
bash .claude/hooks/netsec-health.sh; echo "Exit: $?"
# Expected: Exit 0 if everything is set up from Plan 01, or Exit 1 if scope file missing

# Test 3: Verify non-interactive mode skips repair prompts
echo "" | bash .claude/hooks/netsec-health.sh
# Expected: Same checklist but no repair prompts

# Test 4: Verify script is executable
test -x .claude/hooks/netsec-health.sh && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>
Health-check script prints a categorized pass/fail checklist covering hook files, registrations, scope config, audit infrastructure, and dependencies. Offers interactive guided repair for fixable issues. Returns exit 0 on all-pass, exit 1 on any failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create health-check Claude Code skill</name>
  <files>.claude/skills/netsec-health/SKILL.md</files>
  <action>
Create `.claude/skills/netsec-health/SKILL.md` as a Claude Code skill file.

**Skill frontmatter:**
```yaml
---
name: netsec-health
description: Check that all pentesting safety hooks are installed and working
disable-model-invocation: false
---
```

Note: `disable-model-invocation: false` because the user may want to invoke this proactively (unlike tool skills which should not auto-fire). This skill is diagnostic and interactive.

**Skill instructions (markdown body):**

The instructions should tell Claude to:
1. Run `bash .claude/hooks/netsec-health.sh` to perform the health check
2. Review the output and report the results to the user
3. If any checks fail, explain what each failure means and offer to fix it:
   - Missing hook files: "The hook scripts need to be created. This is unusual if the skill pack was installed correctly."
   - Hooks not executable: "Run `chmod +x .claude/hooks/netsec-pretool.sh .claude/hooks/netsec-posttool.sh`"
   - Hooks not registered: "The .claude/settings.json file is missing hook registrations."
   - Scope file missing: "No target scope is defined. All pentesting commands will be blocked until you create .pentest/scope.json with your allowed targets."
   - Audit directory issues: "The .pentest/ directory needs to be created or is not writable."
4. If all checks pass, confirm the safety architecture is operational

Keep the instructions concise. This skill is a thin wrapper around the bash script — Claude reads the output and provides context.

Create the directory `.claude/skills/netsec-health/` if it does not exist.
  </action>
  <verify>
```bash
# Verify skill file exists and has valid frontmatter
test -f .claude/skills/netsec-health/SKILL.md && echo "PASS: skill file exists" || echo "FAIL"

# Verify frontmatter contains required fields
head -10 .claude/skills/netsec-health/SKILL.md | grep -q "name: netsec-health" && echo "PASS: name field" || echo "FAIL"
head -10 .claude/skills/netsec-health/SKILL.md | grep -q "description:" && echo "PASS: description field" || echo "FAIL"

# Verify instructions reference the health check script
grep -q "netsec-health.sh" .claude/skills/netsec-health/SKILL.md && echo "PASS: references health script" || echo "FAIL"
```
  </verify>
  <done>
Health-check skill SKILL.md exists at `.claude/skills/netsec-health/SKILL.md` with proper frontmatter and instructions that tell Claude to run the bash health-check script and interpret results for the user.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify safety hooks are firing in live Claude Code session</name>
  <files>none</files>
  <action>
This is a human verification checkpoint. The user must verify that the complete safety architecture works in a live Claude Code session. No automated action — the executor presents the verification steps below and waits for user confirmation.
  </action>
  <verify>
1. Start a fresh Claude Code session (hooks load from settings.json at session start)
2. Run `bash .claude/hooks/netsec-health.sh` — all items should pass except scope file
3. Create test scope: `mkdir -p .pentest && echo '{"targets":["localhost","127.0.0.1","scanme.nmap.org"]}' > .pentest/scope.json`
4. Test raw tool blocking: ask Claude to run `nmap localhost` — should be denied with redirect
5. Test out-of-scope blocking: `bash scripts/nmap/discover-live-hosts.sh 10.99.99.99 -j` — should be denied
6. Test in-scope allowing: `bash scripts/nmap/discover-live-hosts.sh localhost -j` — should execute
7. Check audit log: `cat .pentest/audit-$(date +%Y-%m-%d).jsonl | jq .`
8. Clean up: `rm -rf .pentest/`
  </verify>
  <done>
User has confirmed that PreToolUse blocks raw tools and out-of-scope targets, PostToolUse logs audit entries, and the health-check correctly reports system status.
  </done>
</task>

</tasks>

<verification>
1. Health-check bash script produces categorized pass/fail checklist
2. Health-check skill is invocable as a Claude Code skill
3. Both the bash script and skill reference the same verification logic
4. Guided repair in the bash script only activates in interactive mode
5. Live Claude Code session confirms hooks fire on security-tool commands
</verification>

<success_criteria>
- Health-check script exists, is executable, and reports accurate pass/fail status
- Health-check skill exists with valid frontmatter
- Live verification confirms PreToolUse blocks raw tools and out-of-scope targets
- Live verification confirms PostToolUse logs audit entries
- No modifications to any existing scripts
</success_criteria>

<output>
After completion, create `.planning/phases/28-safety-architecture/28-02-SUMMARY.md`
</output>
