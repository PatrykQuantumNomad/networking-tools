---
phase: 27-documentation
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - tests/intg-doc-json-flag.bats
autonomous: true

must_haves:
  truths:
    - "A BATS test verifies every use-case script's --help output contains --json"
    - "A BATS test verifies every use-case script's @usage header contains -j|--json"
    - "Tests catch any future script that omits JSON flag documentation"
  artifacts:
    - path: "tests/intg-doc-json-flag.bats"
      provides: "DOC-01 and DOC-02 verification tests"
      min_lines: 40
  key_links:
    - from: "tests/intg-doc-json-flag.bats"
      to: "scripts/*/*.sh"
      via: "dynamic discovery of use-case scripts"
      pattern: "_discover_use_case_scripts"
---

<objective>
Add BATS verification tests that enforce DOC-01 (help text documents --json flag) and DOC-02 (@usage header includes -j|--json) for all use-case scripts.

Purpose: Automated guardrail ensuring any future use-case script also documents the -j/--json flag. Matches the existing pattern of intg-cli-contracts.bats and intg-script-headers.bats.
Output: New `tests/intg-doc-json-flag.bats` test file with dynamically registered tests.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-documentation/27-01-PLAN.md
@tests/intg-cli-contracts.bats (pattern: dynamic test registration with bats_test_function)
@tests/intg-script-headers.bats (pattern: header field validation with head -10 | grep)
@tests/intg-json-output.bats (pattern: _discover_json_scripts for use-case script discovery)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BATS verification tests for JSON flag documentation</name>
  <files>tests/intg-doc-json-flag.bats</files>
  <action>
Create `tests/intg-doc-json-flag.bats` following the established dynamic test registration pattern from `intg-cli-contracts.bats`.

The file must contain:

**Header comment block:**
```bash
#!/usr/bin/env bats
# tests/intg-doc-json-flag.bats -- Verify -j/--json flag is documented
# DOC-01: --help output contains --json flag with description
# DOC-02: @usage metadata header contains [-j|--json]
```

**Discovery function:** Reuse the same discovery logic as `intg-json-output.bats` (`_discover_use_case_scripts`). Finds all scripts under `scripts/` excluding `lib/`, `common.sh`, `check-docs-completeness.sh`, `diagnostics/`, `check-tools.sh`, and `examples.sh`. Sort output.

**Test function 1 -- DOC-01:**
```bash
_test_help_documents_json() {
    local script="$1"
    run env NO_COLOR=1 bash "$script" --help
    assert_success
    assert_output --partial "--json"
}
```
Register dynamically for every discovered use-case script using `bats_test_function --description "DOC-01 ${local_path}: --help documents --json flag"`.

**Test function 2 -- DOC-02:**
```bash
_test_usage_header_has_json() {
    local script="$1"
    run bash -c "head -10 \"$script\" | grep '# @usage' | grep -c '\\-j|--json'"
    assert_success
    assert [ "$output" -ge 1 ]
}
```
Register dynamically for every discovered use-case script using `bats_test_function --description "DOC-02 ${local_path}: @usage header includes -j|--json"`.

**Meta-test (static):**
```bash
@test "DOC-META: discovery finds all 46 use-case scripts" {
    local count
    count=$(_discover_use_case_scripts | wc -l | tr -d ' ')
    assert [ "$count" -ge 46 ]
}
```

**Per-test setup:**
```bash
setup() {
    load 'test_helper/common-setup'
    _common_setup
}
```

This will produce 46 + 46 + 1 = 93 tests.
  </action>
  <verify>
1. `bats tests/intg-doc-json-flag.bats` -- all 93 tests pass (46 DOC-01 + 46 DOC-02 + 1 meta)
2. `bats tests/` -- full test suite passes with no regressions
  </verify>
  <done>
`tests/intg-doc-json-flag.bats` exists with dynamic DOC-01 and DOC-02 tests covering all 46 use-case scripts. All tests pass. Full test suite passes with the new file included.
  </done>
</task>

</tasks>

<verification>
1. `bats tests/intg-doc-json-flag.bats` passes all 93 tests
2. Full test suite `bats tests/` passes without regressions
3. Removing `[-j|--json]` from any one script's @usage or show_help() causes the corresponding DOC test to fail
</verification>

<success_criteria>
- 93 new tests pass (46 DOC-01 + 46 DOC-02 + 1 meta)
- Full test suite passes
- Future scripts without JSON documentation will be caught by CI
</success_criteria>

<output>
After completion, create `.planning/phases/27-documentation/27-02-SUMMARY.md`
</output>
