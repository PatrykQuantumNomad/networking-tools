---
phase: 05-advanced-tools
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/diagnostics/performance.sh
  - site/src/content/docs/tools/traceroute.md
  - site/src/content/docs/diagnostics/performance.md
autonomous: true

must_haves:
  truths:
    - "Running bash scripts/diagnostics/performance.sh produces a structured latency report with sections for Network Path, Per-Hop Latency, Latency Analysis, and Summary"
    - "performance.sh uses pass/fail/warn counters and report_section following the Pattern B template from dns.sh and connectivity.sh"
    - "performance.sh degrades gracefully when mtr is not installed -- uses report_skip and continues with traceroute-only analysis"
    - "On macOS without sudo, performance.sh warns about mtr requiring sudo and skips per-hop latency rather than failing"
    - "The traceroute/mtr tool page exists at site/src/content/docs/tools/traceroute.md with install info, key flags, use-case descriptions, and macOS notes"
    - "The performance diagnostic page exists at site/src/content/docs/diagnostics/performance.md with section-by-section explanation and severity table"
  artifacts:
    - path: "scripts/diagnostics/performance.sh"
      provides: "Latency diagnostic auto-report"
      contains: "report_section"
    - path: "site/src/content/docs/tools/traceroute.md"
      provides: "Traceroute/mtr tool documentation page"
      contains: "sidebar:"
    - path: "site/src/content/docs/diagnostics/performance.md"
      provides: "Performance diagnostic documentation page"
      contains: "sidebar:"
  key_links:
    - from: "scripts/diagnostics/performance.sh"
      to: "scripts/common.sh"
      via: "source directive and report_pass/fail/warn/skip/section functions"
      pattern: "report_section"
    - from: "scripts/diagnostics/performance.sh"
      to: "traceroute"
      via: "require_cmd"
      pattern: "require_cmd traceroute"
---

<objective>
Create the performance diagnostic script (Pattern B auto-report) and documentation site pages for both the traceroute/mtr tool family and the performance diagnostic.

Purpose: Delivers the structured latency diagnostic (DIAG-007) and site documentation (SITE-015), completing Phase 5's requirement set. The diagnostic follows the same pattern as dns.sh and connectivity.sh from Phase 3.
Output: performance.sh diagnostic script, traceroute.md tool page, performance.md diagnostic page. (The diagnose-performance Makefile target is added by Plan 01 to avoid file conflicts.)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-tools/05-RESEARCH.md

@scripts/common.sh
@scripts/diagnostics/dns.sh
@scripts/diagnostics/connectivity.sh
@site/src/content/docs/tools/dig.md
@site/src/content/docs/diagnostics/connectivity.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create performance diagnostic script</name>
  <files>
    scripts/diagnostics/performance.sh
  </files>
  <action>
Create `scripts/diagnostics/performance.sh` following Pattern B exactly as established by dns.sh and connectivity.sh. This is a non-interactive auto-report with no safety_banner (diagnostics are passive, not active scanning).

**Structure:**
```
#!/usr/bin/env bash
# diagnostics/performance.sh -- Latency diagnostic auto-report
# Traces the network path and identifies per-hop latency bottlenecks
# Pattern B: Diagnostic auto-report (non-interactive, no safety_banner)
```

- source common.sh
- show_help() with Usage/Description/Examples (same format as connectivity.sh)
- help check: `[[ "${1:-}" =~ ^(-h|--help)$ ]] && show_help && exit 0`
- require_cmd traceroute with install hint
- TARGET="${1:-example.com}", OS_TYPE="$(uname -s)"
- Detect mtr: `HAS_MTR=false; check_cmd mtr && HAS_MTR=true`
- If mtr is available on macOS, check sudo: `MTR_USABLE=false; if [[ "$HAS_MTR" == true ]]; then if [[ "$OS_TYPE" == "Darwin" ]] && [[ $EUID -ne 0 ]]; then MTR_USABLE=false; else MTR_USABLE=true; fi; fi`
- Pass/Fail/Warn counters (same pattern as connectivity.sh):
  ```
  PASS_COUNT=0; FAIL_COUNT=0; WARN_COUNT=0
  count_pass() { report_pass "$@"; PASS_COUNT=$((PASS_COUNT + 1)); }
  count_fail() { report_fail "$@"; FAIL_COUNT=$((FAIL_COUNT + 1)); }
  count_warn() { report_warn "$@"; WARN_COUNT=$((WARN_COUNT + 1)); }
  ```
- Report header: `info "=== Performance Diagnostic Report ==="` with target and date

**Section 1: Network Path** (uses traceroute)
- `report_section "Network Path"`
- Run `traceroute -n -q 1 -m 30 "$TARGET" 2>&1` and capture output
- Count hops (non-asterisk lines): if hops > 0, count_pass "Route found: N hops to TARGET"; else count_fail "No route to TARGET"
- Print the traceroute output indented with `echo "$output" | sed 's/^/   /'`
- If any hops show all asterisks (***), count_warn "Hop N: no response (filtered or timeout)"

**Section 2: Per-Hop Latency** (uses mtr if available)
- `report_section "Per-Hop Latency"`
- If MTR_USABLE is true:
  - `info "Running mtr (10 cycles, ~10 seconds)..."`
  - Run `mtr --report --report-wide -c 10 -n "$TARGET" 2>&1` and capture output
  - Print the mtr report indented
  - Parse each hop line: extract loss%, avg latency
  - For hops with >5% packet loss: count_warn "Hop N: X% packet loss"
  - For hops with avg latency >100ms: count_warn "Hop N: high latency (Xms avg)"
  - If all hops have <5% loss and <100ms avg: count_pass "All hops within acceptable thresholds"
- If HAS_MTR is false:
  - `report_skip "mtr not installed (install: brew install mtr / apt install mtr)"`
  - `info "Per-hop latency analysis requires mtr. Continuing with basic path analysis."`
- If HAS_MTR is true but MTR_USABLE is false (macOS no sudo):
  - count_warn "mtr requires sudo on macOS (raw socket access)"
  - `info "Run with: sudo $0 ${TARGET}"`
  - `info "Skipping per-hop latency analysis"`

**Section 3: Latency Analysis** (derived from traceroute/mtr output)
- `report_section "Latency Analysis"`
- If mtr output was collected: analyze it for patterns:
  - Identify the hop with highest average latency
  - Identify if there is a sudden jump between consecutive hops (>50ms increase)
  - Report: count_pass "Latency is consistent across hops" or count_warn "Latency spike detected at hop N (Xms increase)"
- If only traceroute was available:
  - Parse the traceroute output timing values
  - Report basic analysis from whatever timing data is available
  - If no timing data: `info "Limited analysis available without mtr"`

**Section 4: Summary** (same pattern as connectivity.sh)
- `report_section "Summary"`
- Calculate totals, print summary line with pass/fail/warn counts
- Use count_fail for summary if any FAIL, count_warn if only warnings, count_pass if all clean

Make the script executable (chmod +x).
  </action>
  <verify>
```bash
bash scripts/diagnostics/performance.sh --help  # Should print usage and exit 0
bash scripts/diagnostics/performance.sh          # Should run against example.com and produce a report with sections
```
  </verify>
  <done>performance.sh produces a structured report with Network Path, Per-Hop Latency, Latency Analysis, and Summary sections. It degrades gracefully when mtr is missing (report_skip) and warns about sudo on macOS.</done>
</task>

<task type="auto">
  <name>Task 2: Create site documentation pages for traceroute/mtr and performance diagnostic</name>
  <files>
    site/src/content/docs/tools/traceroute.md
    site/src/content/docs/diagnostics/performance.md
  </files>
  <action>
**traceroute.md** (SITE-015) -- follow the exact structure of dig.md and other tool pages:

Frontmatter:
```yaml
---
title: "traceroute / mtr -- Route Tracing"
description: "Trace network paths, analyze per-hop latency, and compare routing protocols"
sidebar:
  order: 15
  badge:
    text: 'New'
    variant: 'tip'
---
```

Sections (follow dig.md structure):
1. **What They Do** -- Explain traceroute (sends packets with incrementing TTL to map the path) and mtr (continuous traceroute + ping with per-hop statistics). Note they are complementary: traceroute for one-shot path discovery, mtr for continuous monitoring and latency analysis.
2. **Running the Examples Script** -- bash and make commands (bash scripts/traceroute/examples.sh TARGET, make traceroute TARGET=host). Note the script prints 10 examples (5 traceroute + 5 mtr) and offers an interactive demo.
3. **Key Flags to Remember** -- Two tables, one for traceroute and one for mtr:
   - Traceroute: -n (numeric), -I (ICMP mode, sudo), -m N (max hops), -q N (probes per hop), -w N (wait timeout), -f N (first TTL), -P tcp (macOS TCP mode), -T (Linux TCP mode)
   - mtr: --report (non-interactive report), --report-wide (full hostnames), -c N (cycles), -n (no DNS), --tcp (TCP mode), --udp (UDP mode), -s N (packet size), -o FIELDS (custom fields)
4. **Install** -- Platform table:
   - macOS: traceroute is pre-installed; mtr via `brew install mtr`
   - Debian/Ubuntu: `apt install traceroute`, `apt install mtr`
   - RHEL/Fedora: `dnf install traceroute`, `dnf install mtr`
5. **Use-Case Scripts** -- Three subsections:
   - trace-network-path.sh: Basic path tracing. When to use, key commands (traceroute -n, traceroute -q 1, traceroute -m 20), make target.
   - diagnose-latency.sh: Per-hop latency analysis with mtr. When to use, key commands (mtr --report, mtr --report-wide, mtr -o "LSAWDV"), make target. Note: requires sudo on macOS.
   - compare-routes.sh: Compare TCP vs ICMP vs UDP routes. When to use, key commands (all three protocol modes with platform notes), make target.
6. **macOS Notes** -- Dedicated section:
   - mtr requires sudo (raw socket access). Run with `sudo bash scripts/traceroute/diagnose-latency.sh TARGET` or `sudo make diagnose-latency TARGET=host`.
   - TCP traceroute uses `-P tcp` on macOS (not `-T` which is Linux-only). The scripts detect this automatically.
   - ICMP and TCP traceroute modes require sudo on both platforms.
7. **Practice Suggestions** -- Trace to well-known hosts (8.8.8.8, 1.1.1.1, cloudflare.com) to see real network paths. Compare routes to same destination from different networks.
8. **Notes** -- Tips: UDP is default and needs no sudo; use -n for faster results; mtr report mode (-r) waits until all cycles complete before printing; typical cycle count of 10 takes ~10 seconds.

**performance.md** -- follow connectivity.md structure exactly:

Frontmatter:
```yaml
---
title: "Performance Diagnostic"
description: "Hop-by-hop latency diagnostic using traceroute and mtr"
sidebar:
  order: 3
---
```

Sections:
1. **What It Checks** -- Overview: traces the network path and identifies where latency occurs hop-by-hop. Lists 4 sections: Network Path, Per-Hop Latency, Latency Analysis, Summary.
2. **Running the Diagnostic** -- bash and make commands. Note: non-interactive, protocol prefix not applicable (targets are hostnames/IPs).
3. **Understanding the Report** -- Section-by-section with check/severity/meaning tables (follow connectivity.md format exactly):
   - Section 1: Network Path -- route found (PASS), no route (FAIL), filtered hops (WARN)
   - Section 2: Per-Hop Latency -- all hops acceptable (PASS), high packet loss >5% (WARN), high latency >100ms (WARN), mtr not installed (SKIP), mtr needs sudo on macOS (WARN)
   - Section 3: Latency Analysis -- consistent latency (PASS), latency spike detected (WARN)
   - Summary: same pattern as connectivity.md
4. **Interpreting Results** -- Common patterns:
   - All PASS: Network path is clean, latency is acceptable at every hop
   - WARN for packet loss at single hop: Could be rate-limiting of ICMP at that hop (common for ISP routers), not necessarily a problem
   - WARN for latency spike: Geographic distance between hops, or congestion at that point
   - mtr SKIP: Install mtr for the full diagnostic; traceroute-only analysis still shows the path
5. **Requirements** -- Tool table:
   - traceroute: Required, pre-installed macOS, apt/dnf install on Linux
   - mtr: Optional but recommended, enhances with per-hop statistics
   - sudo: Required on macOS for mtr; required everywhere for ICMP/TCP traceroute modes
  </action>
  <verify>
```bash
head -10 site/src/content/docs/tools/traceroute.md
head -10 site/src/content/docs/diagnostics/performance.md
```
Verify both files have valid Starlight frontmatter with title, description, and sidebar order.
  </verify>
  <done>traceroute.md exists in site/src/content/docs/tools/ with order 15, New badge, install table, key flags, use-case descriptions, and macOS notes. performance.md exists in site/src/content/docs/diagnostics/ with order 3, section-by-section report explanation, and severity tables.</done>
</task>

</tasks>

<verification>
1. `bash scripts/diagnostics/performance.sh --help` exits 0 with usage info
2. `bash scripts/diagnostics/performance.sh` produces a report with report_section headers
3. `head -6 site/src/content/docs/tools/traceroute.md` shows valid Starlight frontmatter
4. `head -6 site/src/content/docs/diagnostics/performance.md` shows valid Starlight frontmatter
5. `grep -c "report_section" scripts/diagnostics/performance.sh` returns 4 (one per section)
</verification>

<success_criteria>
- performance.sh follows Pattern B exactly (preamble, require_cmd, default target, report_section, count_pass/fail/warn, summary)
- performance.sh degrades gracefully: works with traceroute only, enhanced with mtr
- performance.sh handles macOS mtr sudo requirement with warning (not auto-elevation)
- traceroute.md has complete tool documentation matching the dig.md pattern
- performance.md has complete diagnostic documentation matching the connectivity.md pattern
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-tools/05-02-SUMMARY.md`
</output>
