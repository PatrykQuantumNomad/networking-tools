---
phase: 05-advanced-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/traceroute/examples.sh
  - scripts/traceroute/trace-network-path.sh
  - scripts/traceroute/diagnose-latency.sh
  - scripts/traceroute/compare-routes.sh
  - scripts/check-tools.sh
  - Makefile
  - USECASES.md
autonomous: true

must_haves:
  truths:
    - "Running bash scripts/traceroute/examples.sh 8.8.8.8 prints 10 numbered educational examples covering traceroute (1-5) and mtr (6-10)"
    - "trace-network-path.sh prints 10 examples of basic path tracing commands and offers an interactive demo"
    - "diagnose-latency.sh prints 10 examples of mtr per-hop latency analysis commands; on macOS without sudo it warns and exits rather than failing silently"
    - "compare-routes.sh prints 10 examples comparing TCP vs ICMP vs UDP routes with platform-specific flag detection"
    - "make check detects traceroute and mtr as installed or missing alongside the existing 14 tools"
    - "make traceroute TARGET=8.8.8.8 runs examples.sh; make trace-path, diagnose-latency, compare-routes, diagnose-performance all work with sensible defaults"
    - "USECASES.md has a Route Tracing & Performance section with entries for all new targets"
  artifacts:
    - path: "scripts/traceroute/examples.sh"
      provides: "10 educational examples for traceroute and mtr"
      contains: "require_cmd traceroute"
    - path: "scripts/traceroute/trace-network-path.sh"
      provides: "Basic path tracing use-case"
      contains: "safety_banner"
    - path: "scripts/traceroute/diagnose-latency.sh"
      provides: "mtr per-hop latency analysis use-case"
      contains: "require_cmd mtr"
    - path: "scripts/traceroute/compare-routes.sh"
      provides: "TCP vs ICMP vs UDP route comparison use-case"
      contains: "OS_TYPE"
    - path: "scripts/check-tools.sh"
      provides: "traceroute and mtr in TOOLS and TOOL_ORDER"
      contains: "[traceroute]"
    - path: "Makefile"
      provides: "traceroute, trace-path, diagnose-latency, compare-routes, diagnose-performance targets"
      contains: "diagnose-performance:"
    - path: "USECASES.md"
      provides: "Route Tracing & Performance section"
      contains: "Route Tracing"
  key_links:
    - from: "scripts/traceroute/examples.sh"
      to: "scripts/common.sh"
      via: "source directive"
      pattern: 'source "\$\(dirname "\$0"\)/\.\./common\.sh"'
    - from: "scripts/traceroute/diagnose-latency.sh"
      to: "mtr sudo detection"
      via: "EUID check on Darwin"
      pattern: "EUID.*-ne 0"
    - from: "scripts/traceroute/compare-routes.sh"
      to: "platform detection"
      via: "OS_TYPE branching for TCP flag"
      pattern: 'OS_TYPE.*uname -s'
    - from: "Makefile"
      to: "scripts/traceroute/*.sh"
      via: "make targets"
      pattern: "bash scripts/traceroute/"
---

<objective>
Create the traceroute/mtr tool family: examples.sh with 10 educational examples, three use-case scripts (trace-network-path, diagnose-latency, compare-routes), and integrate into check-tools.sh, Makefile, and USECASES.md.

Purpose: Delivers the core traceroute/mtr scripts that form the educational content of Phase 5. Users get the same Pattern A experience established for dig, curl, and netcat.
Output: 4 executable scripts under scripts/traceroute/, updated check-tools.sh, Makefile targets (including diagnose-performance for Plan 02's script), and USECASES.md entries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-tools/05-RESEARCH.md

@scripts/common.sh
@scripts/dig/examples.sh
@scripts/dig/query-dns-records.sh
@scripts/check-tools.sh
@Makefile
@USECASES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create traceroute/mtr examples.sh and 3 use-case scripts</name>
  <files>
    scripts/traceroute/examples.sh
    scripts/traceroute/trace-network-path.sh
    scripts/traceroute/diagnose-latency.sh
    scripts/traceroute/compare-routes.sh
  </files>
  <action>
Create `scripts/traceroute/` directory and four scripts following the established Pattern A template (see dig/examples.sh and dig/query-dns-records.sh for exact structure).

**examples.sh** (TOOL-014):
- Preamble: `#!/usr/bin/env bash`, source common.sh, show_help(), help check, require_cmd traceroute with install hint "apt install traceroute (Debian/Ubuntu) | dnf install traceroute (RHEL/Fedora) | pre-installed on macOS", require_target, safety_banner
- Check mtr availability: `HAS_MTR=false; check_cmd mtr && HAS_MTR=true`
- Header: `info "=== Traceroute & MTR Examples ==="` with target display
- 10 numbered examples (info "N) Title" + echo "   command" + echo ""):
  1. Basic traceroute (traceroute TARGET)
  2. Numeric output -- skip DNS lookups for speed (traceroute -n TARGET)
  3. ICMP traceroute -- requires sudo (sudo traceroute -I TARGET)
  4. Limit to 15 hops, 1 probe per hop (traceroute -m 15 -q 1 TARGET)
  5. TCP traceroute -- platform-specific: use `if [[ "$(uname -s)" == "Darwin" ]]` to print `sudo traceroute -P tcp TARGET` on macOS, `sudo traceroute -T TARGET` on Linux
  6. mtr -- continuous traceroute with live statistics (mtr TARGET). If HAS_MTR is false, add note "(mtr not installed -- brew install mtr / apt install mtr)"
  7. mtr report mode -- 10 cycles, non-interactive (mtr --report -c 10 TARGET). Note "requires sudo on macOS"
  8. mtr wide report -- show full hostnames (mtr --report --report-wide -c 10 TARGET)
  9. mtr with no DNS resolution (mtr --report -n -c 10 TARGET)
  10. mtr specifying max hops (mtr --report -m 20 -c 10 TARGET)
- Interactive demo: `[[ -t 0 ]] || exit 0`, then `read -rp "Run a basic traceroute to ${TARGET}? [y/N] "`, if yes run `traceroute -n -q 1 -m 15 "$TARGET"` (fast, safe, no sudo needed)

**trace-network-path.sh** (TOOL-015):
- Use-case pattern (see dig/query-dns-records.sh): source common.sh, show_help with Usage/Description/Examples, help check, require_cmd traceroute, TARGET="${1:-example.com}", safety_banner
- Educational context (WHY): explain what traceroute does (sends packets with incrementing TTL, each hop responds with ICMP Time Exceeded)
- 10 numbered examples of path tracing commands:
  1. Basic path trace (traceroute TARGET)
  2. Numeric -- skip DNS for speed (traceroute -n TARGET)
  3. Set max hops to 20 (traceroute -m 20 TARGET)
  4. Single probe per hop for faster results (traceroute -q 1 TARGET)
  5. Set wait timeout to 2 seconds (traceroute -w 2 TARGET)
  6. Start from hop 5 -- skip known local hops (traceroute -f 5 TARGET)
  7. ICMP mode -- requires sudo (sudo traceroute -I TARGET)
  8. TCP mode -- platform-detect with OS_TYPE check (sudo traceroute -P tcp / -T)
  9. Trace to port 443 -- TCP to specific port (platform-detect)
  10. Trace with AS number lookups (traceroute -A TARGET on Linux, note macOS does not support -A)
- Interactive demo: run `traceroute -n -q 1 -m 15 "$TARGET"`

**diagnose-latency.sh** (TOOL-016, TOOL-018):
- Preamble, show_help, help check, require_cmd mtr with install hint
- TARGET="${1:-example.com}", OS_TYPE="$(uname -s)"
- **mtr sudo detection (TOOL-018):** After require_cmd, check: `if [[ "$OS_TYPE" == "Darwin" ]] && [[ $EUID -ne 0 ]]; then warn "mtr requires sudo on macOS (raw socket access)"; info "Re-run with: sudo $0 ${TARGET}"; exit 1; fi`. NEVER auto-elevate with exec sudo -- warn and exit per research recommendation.
- safety_banner
- Educational context: explain why per-hop latency matters
- 10 numbered examples of mtr latency analysis:
  1. Basic mtr report (mtr --report -c 10 TARGET)
  2. Wide report with full hostnames (mtr --report --report-wide -c 10 TARGET)
  3. No DNS resolution for faster results (mtr --report -n -c 10 TARGET)
  4. 20 cycles for more accurate stats (mtr --report -c 20 TARGET)
  5. Limit to 20 hops (mtr --report -m 20 -c 10 TARGET)
  6. UDP mode -- default protocol (mtr --report --udp -c 10 TARGET)
  7. TCP mode on port 80 (mtr --report --tcp --port 80 -c 10 TARGET)
  8. Custom report fields -- show loss, sent, avg, worst, stdev (mtr --report -o "LSAWDV" -c 10 TARGET)
  9. Set packet size to 1024 bytes (mtr --report -s 1024 -c 10 TARGET)
  10. Compare two destinations side by side (run mtr to TARGET then to 8.8.8.8)
- Interactive demo: run `mtr --report -n -c 5 "$TARGET"` (5 cycles for speed, ~5 seconds)

**compare-routes.sh** (TOOL-017):
- Preamble, show_help, help check, require_cmd traceroute, TARGET="${1:-example.com}", OS_TYPE="$(uname -s)"
- safety_banner
- Educational context: explain why different protocols take different paths (firewalls, routing policies)
- Note at top: "ICMP and TCP modes require sudo; UDP (default) does not"
- 10 numbered examples:
  1. UDP traceroute -- default, no sudo (traceroute -n TARGET)
  2. ICMP traceroute -- requires sudo (sudo traceroute -I -n TARGET)
  3. TCP traceroute -- platform-detect for -P tcp (macOS) vs -T (Linux), requires sudo
  4. Reduced probes for faster comparison (traceroute -n -q 1 TARGET for each protocol)
  5. Compare hop count across protocols (traceroute -m 30 for each)
  6. Set specific wait timeout for comparison (traceroute -w 3 for each)
  7. mtr TCP mode if available (mtr --report --tcp -c 10 TARGET), check HAS_MTR
  8. mtr UDP mode if available (mtr --report --udp -c 10 TARGET)
  9. Trace to specific port with TCP (platform-detect, port 443)
  10. Full comparison script suggestion -- run all three protocols sequentially
- Interactive demo: run UDP traceroute only (no sudo needed): `traceroute -n -q 1 -m 15 "$TARGET"`

All scripts must be executable (chmod +x).
  </action>
  <verify>
Run each script with --help to verify they parse correctly:
```bash
bash scripts/traceroute/examples.sh --help
bash scripts/traceroute/trace-network-path.sh --help
bash scripts/traceroute/diagnose-latency.sh --help
bash scripts/traceroute/compare-routes.sh --help
```
All four should print usage info and exit 0. Also verify examples.sh requires a target argument (exits non-zero without one).
  </verify>
  <done>All four scripts exist, are executable, follow the established Pattern A structure (source common.sh, show_help, require_cmd, safety_banner, 10 numbered examples, interactive demo). diagnose-latency.sh checks for sudo on macOS and exits with a warning rather than failing silently. compare-routes.sh uses OS_TYPE to select the correct TCP traceroute flag.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate traceroute/mtr into check-tools.sh, Makefile, and USECASES.md</name>
  <files>
    scripts/check-tools.sh
    Makefile
    USECASES.md
  </files>
  <action>
**check-tools.sh** (INFRA-009 partial):
- Add to TOOLS associative array:
  `[traceroute]="apt install traceroute (Debian/Ubuntu) | dnf install traceroute (RHEL/Fedora) | pre-installed on macOS"`
  `[mtr]="apt install mtr (Debian/Ubuntu) | dnf install mtr (RHEL/Fedora) | brew install mtr (macOS)"`
- Add `traceroute` and `mtr` to end of TOOL_ORDER array (after nc)
- Add version detection case in get_version() for traceroute: macOS BSD traceroute has no --version flag, so add a dedicated case: `traceroute) echo "installed" ;;`
  mtr uses `mtr --version` which works via the default case, so no special handling needed.

**Makefile** (INFRA-009 partial):
- Add to .PHONY line: `traceroute trace-path diagnose-latency compare-routes diagnose-performance`
- Add targets after the existing diagnostic targets section. Follow the existing pattern exactly (see dig, netcat targets for reference):
```makefile
traceroute: ## Run traceroute/mtr examples (usage: make traceroute TARGET=<host>)
	@bash scripts/traceroute/examples.sh $(TARGET)

trace-path: ## Trace network path (usage: make trace-path TARGET=<host>)
	@bash scripts/traceroute/trace-network-path.sh $(or $(TARGET),example.com)

diagnose-latency: ## Diagnose per-hop latency with mtr (usage: make diagnose-latency TARGET=<host>)
	@bash scripts/traceroute/diagnose-latency.sh $(or $(TARGET),example.com)

compare-routes: ## Compare TCP/ICMP/UDP routes (usage: make compare-routes TARGET=<host>)
	@bash scripts/traceroute/compare-routes.sh $(or $(TARGET),example.com)

diagnose-performance: ## Run performance diagnostic (usage: make diagnose-performance TARGET=<host>)
	@bash scripts/diagnostics/performance.sh $(or $(TARGET),example.com)
```
Note: traceroute target (examples.sh) uses $(TARGET) directly (no default) because examples.sh uses require_target. The use-case scripts use $(or $(TARGET),example.com) because they have sensible defaults. The diagnose-performance target points to scripts/diagnostics/performance.sh which will be created by Plan 02.

**USECASES.md**:
- Add a new section "## Route Tracing & Performance" between "Network Diagnostics" and "File Carving & Forensics":
```markdown
## Route Tracing & Performance

| I want to... | Command | Tool |
| -------------- | --------- | ------ |
| Trace the network path to a host | `make trace-path TARGET=<host>` | traceroute |
| Analyze per-hop latency | `make diagnose-latency TARGET=<host>` | mtr |
| Compare TCP/ICMP/UDP routes | `make compare-routes TARGET=<host>` | traceroute |
| Run a full performance diagnostic | `make diagnose-performance TARGET=<host>` | traceroute, mtr |
```
- Also update the "Typical Engagement Flow" section to include route tracing:
  Add `1c. Route trace  make trace-path TARGET=<host>` after the diagnostics line.
  </action>
  <verify>
Run `make check` and verify it lists traceroute and mtr in the output (16 total tools). Run `make help` and verify traceroute, trace-path, diagnose-latency, compare-routes, diagnose-performance appear in the help listing. Visually inspect USECASES.md for the new section.
  </verify>
  <done>check-tools.sh reports 16 tools (14 existing + traceroute + mtr). Makefile has 5 new targets (4 traceroute + diagnose-performance) that appear in `make help`. USECASES.md has a "Route Tracing & Performance" section with 4 entries plus an updated engagement flow.</done>
</task>

</tasks>

<verification>
1. `bash scripts/traceroute/examples.sh --help` exits 0 with usage info
2. `bash scripts/traceroute/examples.sh` (no target) exits non-zero with "requires target" message
3. `bash scripts/traceroute/trace-network-path.sh --help` exits 0
4. `bash scripts/traceroute/diagnose-latency.sh --help` exits 0
5. `bash scripts/traceroute/compare-routes.sh --help` exits 0
6. `make check` shows 16 tools with traceroute and mtr listed
7. `make help` shows traceroute, trace-path, diagnose-latency, compare-routes, diagnose-performance targets
8. grep "Route Tracing" USECASES.md returns a match
</verification>

<success_criteria>
- All 4 scripts under scripts/traceroute/ exist and are executable
- examples.sh has 10 numbered examples (5 traceroute + 5 mtr) with correct platform detection for TCP flag
- diagnose-latency.sh has macOS sudo detection that warns and exits (does not auto-elevate)
- compare-routes.sh detects OS_TYPE and prints platform-correct TCP traceroute flags
- check-tools.sh recognizes traceroute and mtr (16 total tools)
- Makefile targets work with correct argument passing (including diagnose-performance)
- USECASES.md has route tracing entries
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-tools/05-01-SUMMARY.md`
</output>
