---
phase: 16-use-case-script-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/nmap/discover-live-hosts.sh
  - scripts/nmap/scan-web-vulnerabilities.sh
  - scripts/nmap/identify-ports.sh
  - scripts/hping3/test-firewall-rules.sh
  - scripts/hping3/detect-firewall.sh
autonomous: true

must_haves:
  truths:
    - "Running any of the 5 migrated scripts with --help prints usage and exits 0"
    - "Running any of the 5 migrated scripts without -x produces identical educational output to pre-migration"
    - "Running any of the 5 migrated scripts with -x and piped stdin rejects with interactive terminal warning"
  artifacts:
    - path: "scripts/nmap/discover-live-hosts.sh"
      provides: "nmap live host discovery dual-mode"
      contains: "parse_common_args"
    - path: "scripts/nmap/scan-web-vulnerabilities.sh"
      provides: "nmap web vuln scanning dual-mode"
      contains: "parse_common_args"
    - path: "scripts/nmap/identify-ports.sh"
      provides: "port identification dual-mode (no safety_banner)"
      contains: "parse_common_args"
    - path: "scripts/hping3/test-firewall-rules.sh"
      provides: "hping3 firewall rule testing dual-mode"
      contains: "parse_common_args"
    - path: "scripts/hping3/detect-firewall.sh"
      provides: "hping3 firewall detection dual-mode"
      contains: "parse_common_args"
  key_links:
    - from: "each migrated script"
      to: "scripts/lib/args.sh"
      via: "parse_common_args call"
      pattern: "parse_common_args"
    - from: "each migrated script"
      to: "scripts/lib/output.sh"
      via: "run_or_show and confirm_execute calls"
      pattern: "run_or_show|confirm_execute"
---

<objective>
Migrate 5 nmap and hping3 use-case scripts to the dual-mode pattern: discover-live-hosts, scan-web-vulnerabilities, identify-ports, test-firewall-rules, detect-firewall.

Purpose: These are the simplest target-required use-case scripts with the highest run_or_show conversion rates (~38 of 50 examples convert).
Output: 5 scripts accepting -h/-v/-q/-x flags with run_or_show for all eligible examples.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-use-case-script-migration/16-RESEARCH.md
@.planning/phases/15-examples-script-migration/15-01-SUMMARY.md
@scripts/nmap/examples.sh (reference pattern -- already migrated)
@scripts/lib/args.sh
@scripts/lib/output.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate nmap/discover-live-hosts, nmap/scan-web-vulnerabilities, nmap/identify-ports</name>
  <files>
    scripts/nmap/discover-live-hosts.sh
    scripts/nmap/scan-web-vulnerabilities.sh
    scripts/nmap/identify-ports.sh
  </files>
  <action>
Apply the proven nmap/examples.sh migration pattern to each script. For each:

1. **Replace inline help check** with `parse_common_args "$@"` + `set -- "${REMAINING_ARGS[@]+${REMAINING_ARGS[@]}}"`. Remove `[[ "${1:-}" =~ ^(-h|--help)$ ]] && show_help && exit 0`.

2. **Add confirm_execute** between variable setup and safety_banner:
   ```
   confirm_execute "${1:-}"
   safety_banner
   ```

3. **Convert eligible examples** from `info + echo + echo ""` to `run_or_show`:
   ```bash
   # BEFORE:
   info "1) Ping sweep to find live hosts"
   echo "   nmap -sn ${TARGET}/24"
   echo ""

   # AFTER:
   run_or_show "1) Ping sweep to find live hosts" \
       nmap -sn "$TARGET/24"
   ```

4. **Guard interactive demo** with EXECUTE_MODE:
   ```bash
   if [[ "${EXECUTE_MODE:-show}" == "show" ]]; then
       [[ ! -t 0 ]] && exit 0
       read -rp "..." answer
       ...
   fi
   ```

**Per-script notes:**

- **discover-live-hosts.sh**: All 10 examples use `${TARGET}/24` or `${TARGET}`. Convert all 10 to run_or_show. Note the `/24` suffix -- use `"$TARGET/24"` in the run_or_show command arg. Example 10 has `--min-rate 300` -- that's fine for run_or_show.

- **scan-web-vulnerabilities.sh**: All 10 examples use `${TARGET}`. Convert all 10 to run_or_show. Some have multiple flags -- all are single nmap commands suitable for run_or_show.

- **identify-ports.sh**: SPECIAL CASE -- no `require_cmd`, no `safety_banner`. Add `parse_common_args` + `set --` after show_help. Add `confirm_execute "${1:-}"` directly before the examples (no safety_banner to add). Examples 1-3 are local `lsof` commands with no `$TARGET` -- keep as info+echo. Example 4 has `<process-name>` placeholder -- keep as info+echo. Example 5 is `netstat` with no `$TARGET` -- keep as info+echo. Examples 6-9 use `nmap ... ${TARGET}` -- convert to run_or_show. Example 10 is a multi-command pipeline with `|` -- keep as info+echo. Total: 4 convertible. The interactive demo has an if/else for localhost vs remote -- wrap the entire block in EXECUTE_MODE guard.
  </action>
  <verify>
For each of the 3 scripts, run:
1. `bash scripts/nmap/discover-live-hosts.sh --help` -- exits 0, shows "Usage:"
2. `bash scripts/nmap/identify-ports.sh -h` -- exits 0, shows "Usage:"
3. `echo "" | bash scripts/nmap/scan-web-vulnerabilities.sh -x localhost 2>&1` -- exits non-zero, mentions "interactive terminal"
4. Verify `scripts/nmap/identify-ports.sh` does NOT contain `safety_banner`
5. Verify each script contains `parse_common_args`, `confirm_execute`, and `EXECUTE_MODE`
  </verify>
  <done>
Three nmap use-case scripts accept -h/-v/-q/-x flags. discover-live-hosts and scan-web-vulnerabilities have 10 run_or_show each. identify-ports has 4 run_or_show (local lsof commands and multi-command pipeline preserved as info+echo). No safety_banner added to identify-ports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate hping3/test-firewall-rules and hping3/detect-firewall</name>
  <files>
    scripts/hping3/test-firewall-rules.sh
    scripts/hping3/detect-firewall.sh
  </files>
  <action>
Apply the same migration pattern to both hping3 use-case scripts.

**Per-script notes:**

- **test-firewall-rules.sh**: All 10 examples use `sudo hping3 ... $TARGET`. Examples 1-9 are single commands -- convert all 9 to run_or_show. Example 10 has `&&` chaining two commands (`sudo hping3 -S ... && sudo hping3 -A ...`) -- keep as info+echo. Preserve the `warn` line about root/sudo after TARGET assignment.

- **detect-firewall.sh**: All 10 examples use `sudo hping3 ... $TARGET`. Examples 1-9 are single commands -- convert all 9 to run_or_show. Example 10 has `;` chaining three commands -- keep as info+echo. Preserve any warning lines about root/sudo.

Both scripts have `require_target` -- verify it is AFTER `set --` so positional args are properly restored.

Note: these scripts use `require_target "$1"` not `require_target "${1:-}"`. After parse_common_args + set --, `$1` should work correctly. Keep the same pattern.
  </action>
  <verify>
For each of the 2 scripts, run:
1. `bash scripts/hping3/test-firewall-rules.sh --help` -- exits 0, shows "Usage:"
2. `bash scripts/hping3/detect-firewall.sh -h` -- exits 0, shows "Usage:"
3. `echo "" | bash scripts/hping3/test-firewall-rules.sh -x localhost 2>&1` -- exits non-zero, mentions "interactive terminal"
4. Verify each script contains `parse_common_args`, `run_or_show`, `confirm_execute`, and `EXECUTE_MODE`
  </verify>
  <done>
Both hping3 use-case scripts accept dual-mode flags. Each has 9 run_or_show examples and 1 multi-command info+echo example preserved.
  </done>
</task>

</tasks>

<verification>
For all 5 scripts:
1. `--help` and `-h` both exit 0 and print "Usage:"
2. Running with a target (no -x) produces educational output containing numbered examples
3. `-x` with piped stdin exits non-zero with "interactive terminal" warning
4. grep confirms `parse_common_args`, `confirm_execute`, `EXECUTE_MODE` present in each file
5. nmap/identify-ports.sh does NOT contain `safety_banner` (it never had one)
</verification>

<success_criteria>
All 5 nmap and hping3 use-case scripts accept dual-mode flags and produce backward-compatible output.
</success_criteria>

<output>
After completion, create `.planning/phases/16-use-case-script-migration/16-01-SUMMARY.md`
</output>
