---
phase: 16-use-case-script-migration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/gobuster/discover-directories.sh
  - scripts/gobuster/enumerate-subdomains.sh
  - scripts/traceroute/trace-network-path.sh
  - scripts/traceroute/diagnose-latency.sh
  - scripts/traceroute/compare-routes.sh
autonomous: true

must_haves:
  truths:
    - "Running any of the 5 migrated scripts with --help prints usage and exits 0"
    - "Running any of the 5 migrated scripts without -x produces identical educational output to pre-migration"
    - "Running any of the 5 migrated scripts with -x and piped stdin rejects with interactive terminal warning"
  artifacts:
    - path: "scripts/gobuster/discover-directories.sh"
      provides: "gobuster directory discovery dual-mode"
      contains: "parse_common_args"
    - path: "scripts/gobuster/enumerate-subdomains.sh"
      provides: "gobuster subdomain enumeration dual-mode"
      contains: "parse_common_args"
    - path: "scripts/traceroute/trace-network-path.sh"
      provides: "traceroute path tracing dual-mode"
      contains: "parse_common_args"
    - path: "scripts/traceroute/diagnose-latency.sh"
      provides: "mtr latency diagnosis dual-mode"
      contains: "parse_common_args"
    - path: "scripts/traceroute/compare-routes.sh"
      provides: "route comparison dual-mode"
      contains: "parse_common_args"
  key_links:
    - from: "each migrated script"
      to: "scripts/lib/args.sh"
      via: "parse_common_args call"
      pattern: "parse_common_args"
    - from: "each migrated script"
      to: "scripts/lib/output.sh"
      via: "run_or_show and confirm_execute calls"
      pattern: "run_or_show|confirm_execute"
---

<objective>
Migrate 5 gobuster and traceroute use-case scripts to the dual-mode pattern: discover-directories, enumerate-subdomains, trace-network-path, diagnose-latency, compare-routes.

Purpose: These scripts have multi-positional args (gobuster WORDLIST as $2), platform conditionals (traceroute Darwin/Linux), and mtr sudo checks. Edge cases similar to Phase 15-02 patterns.
Output: 5 scripts accepting -h/-v/-q/-x flags with run_or_show for eligible examples.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-use-case-script-migration/16-RESEARCH.md
@.planning/phases/15-examples-script-migration/15-02-SUMMARY.md
@scripts/nmap/examples.sh (reference pattern -- already migrated)
@scripts/traceroute/examples.sh (reference -- already migrated, has platform conditionals)
@scripts/lib/args.sh
@scripts/lib/output.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate gobuster/discover-directories and gobuster/enumerate-subdomains</name>
  <files>
    scripts/gobuster/discover-directories.sh
    scripts/gobuster/enumerate-subdomains.sh
  </files>
  <action>
Apply the migration pattern. Both scripts use multi-positional args: `TARGET="${1:-...}"` and `WORDLIST="${2:-$PROJECT_ROOT/wordlists/...}"`.

After `parse_common_args "$@"` + `set -- "${REMAINING_ARGS[@]+${REMAINING_ARGS[@]}}"`, both `$1` (TARGET) and `$2` (WORDLIST) are restored. The wordlist existence check `[[ ! -f "$WORDLIST" ]]` must stay AFTER `set --` and BEFORE `safety_banner`.

**Per-script notes:**

- **discover-directories.sh**: All 10 examples use `${TARGET}` and `${WORDLIST}`. Most are single `gobuster dir ...` commands. Example 8 uses `${PROJECT_ROOT}/wordlists/...` literal path -- keep as info+echo. Example 10 writes to file (`-o dir-results.txt`) -- technically a single command, but creates side-effect files. Keep as info+echo. Convert examples 1-7, 9 to run_or_show (8 total). Use proper quoting: `gobuster dir -u "$TARGET" -w "$WORDLIST" -t 10`.

- **enumerate-subdomains.sh**: All 10 examples use `${TARGET}` and `${WORDLIST}`. Example 7 uses `${PROJECT_ROOT}/wordlists/...` literal -- keep as info+echo. Example 8 writes to file (`-o subdomain-results.txt`) -- keep as info+echo. Example 10 writes to file -- keep as info+echo. Convert examples 1-6, 9 to run_or_show (7 total).

Guard interactive demos with EXECUTE_MODE. Preserve wordlist existence checks.
  </action>
  <verify>
For each of the 2 scripts, run:
1. `bash scripts/gobuster/discover-directories.sh --help` -- exits 0, shows "Usage:"
2. `bash scripts/gobuster/enumerate-subdomains.sh -h` -- exits 0
3. Verify each script contains `parse_common_args`, `confirm_execute`, and `EXECUTE_MODE`
4. Verify the wordlist `[[ ! -f "$WORDLIST" ]]` check is preserved
  </verify>
  <done>
Both gobuster use-case scripts accept dual-mode flags. discover-directories has 8 run_or_show. enumerate-subdomains has 7 run_or_show. Wordlist checks and multi-positional args preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate traceroute/trace-network-path, traceroute/diagnose-latency, traceroute/compare-routes</name>
  <files>
    scripts/traceroute/trace-network-path.sh
    scripts/traceroute/diagnose-latency.sh
    scripts/traceroute/compare-routes.sh
  </files>
  <action>
Apply the migration pattern. These scripts have platform conditionals (`OS_TYPE`, `HAS_MTR`) and mtr-specific sudo checks. Per Phase 15-02 pattern: platform conditionals wrap run_or_show calls (not the other way around).

**Per-script notes:**

- **trace-network-path.sh**: Has `OS_TYPE="$(uname -s)"` variable. Examples 1-7 are single `traceroute` commands with `${TARGET}` -- convert to run_or_show. Examples 8, 9 have platform-conditional if/else blocks:
  ```bash
  if [[ "$OS_TYPE" == "Darwin" ]]; then
      run_or_show "8) TCP mode..." \
          sudo traceroute -P tcp "$TARGET"
  else
      run_or_show "8) TCP mode..." \
          sudo traceroute -T "$TARGET"
  fi
  ```
  Convert both examples 8 and 9 with platform conditionals wrapping run_or_show. Example 10 has platform conditional with `Note:` annotation -- keep as info+echo (multi-line output with conditional text). Total: 9 convertible.

- **diagnose-latency.sh**: Uses `mtr` (not traceroute). Has a macOS sudo check that exits early. All 10 examples are `mtr` commands. Per Phase 15-02 decision: "mtr examples kept as info+echo since mtr may not be installed." However, this script calls `require_cmd mtr` at the top -- so mtr IS required. All 10 examples are single `mtr` commands with `${TARGET}`. Example 10 has two sequential commands and a "Tip:" annotation -- keep as info+echo. Convert examples 1-9 to run_or_show (9 total). The macOS sudo check at line ~29-33 must remain AFTER `set --` and BEFORE `confirm_execute`.

- **compare-routes.sh**: Has `OS_TYPE` and `HAS_MTR` variables. Many examples have multi-command blocks (examples 4, 5, 6 show UDP/ICMP/TCP commands on separate echo lines). Keep ALL multi-command examples as info+echo. Examples 1, 2 are single commands -- convert to run_or_show. Example 3 has platform conditional -- convert with platform conditional wrapping run_or_show. Examples 4-6 are multi-command comparisons (3 echo lines each) -- keep as info+echo. Examples 7, 8 are mtr commands -- if HAS_MTR: convert to run_or_show. Example 9 has platform conditional -- convert. Example 10 is a multi-command comparison script -- keep as info+echo. Total: ~4-5 convertible (1, 2, 3, 9 with platform wrapping, plus 7 and 8 with HAS_MTR wrapping).

For examples 7 and 8 in compare-routes.sh, the if/else already exists for HAS_MTR. Wrap the inner command in run_or_show within the existing conditional. Keep the "not installed" branch as info+echo.
  </action>
  <verify>
For each of the 3 scripts, run:
1. `bash scripts/traceroute/trace-network-path.sh --help` -- exits 0, shows "Usage:"
2. `bash scripts/traceroute/diagnose-latency.sh -h` -- exits 0
3. `bash scripts/traceroute/compare-routes.sh --help` -- exits 0
4. Verify each script contains `parse_common_args`, `confirm_execute`, and `EXECUTE_MODE`
5. Verify platform conditionals wrap run_or_show (not the other way around) in trace-network-path.sh and compare-routes.sh
  </verify>
  <done>
Three traceroute use-case scripts accept dual-mode flags. trace-network-path has 9 run_or_show (2 with platform conditionals). diagnose-latency has 9 run_or_show (macOS sudo check preserved). compare-routes has ~5 run_or_show (multi-command comparisons preserved as info+echo).
  </done>
</task>

</tasks>

<verification>
For all 5 scripts:
1. `--help` and `-h` both exit 0 and print "Usage:"
2. Running with a target (no -x) produces educational output containing numbered examples
3. `-x` with piped stdin exits non-zero with "interactive terminal" warning
4. grep confirms `parse_common_args`, `confirm_execute`, `EXECUTE_MODE` present in each file
5. Platform conditionals in traceroute scripts wrap run_or_show calls
6. Wordlist checks preserved in gobuster scripts
7. mtr sudo check preserved in diagnose-latency.sh
</verification>

<success_criteria>
All 5 gobuster and traceroute use-case scripts accept dual-mode flags with platform-specific and multi-positional arg edge cases handled correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/16-use-case-script-migration/16-04-SUMMARY.md`
</output>
