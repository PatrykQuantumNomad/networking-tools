---
phase: 20-script-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/intg-cli-contracts.bats
autonomous: true

must_haves:
  truths:
    - "Every script exits 0 on --help and output contains Usage:"
    - "Every parse_common_args script rejects piped stdin with -x flag"
    - "Scripts are discovered dynamically via find -- no hardcoded script paths"
    - "Tests pass on systems missing pentesting tools via mock commands in PATH"
  artifacts:
    - path: "tests/intg-cli-contracts.bats"
      provides: "CLI contract integration tests for all scripts"
      min_lines: 80
      contains: "bats_test_function"
  key_links:
    - from: "tests/intg-cli-contracts.bats"
      to: "scripts/*/*.sh"
      via: "find-based dynamic discovery at file parse time"
      pattern: "find.*scripts.*-name.*\\.sh"
    - from: "tests/intg-cli-contracts.bats"
      to: "tests/test_helper/common-setup.bash"
      via: "load in setup()"
      pattern: "load.*test_helper/common-setup"
---

<objective>
Create CLI contract integration tests that dynamically discover all scripts and verify --help output (INTG-01), execute-mode stdin rejection (INTG-02), dynamic discovery (INTG-03), and CI mock compatibility (INTG-04).

Purpose: Prove every script in the project honors the CLI contract -- help works, execute-mode is safe -- without maintaining a hardcoded script list. Tests auto-grow as scripts are added.
Output: tests/intg-cli-contracts.bats with ~132 dynamically registered tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-script-integration-tests/20-RESEARCH.md
@tests/test_helper/common-setup.bash
@tests/lib-args.bats
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test file with help contracts and dynamic discovery (INTG-01, INTG-03)</name>
  <files>tests/intg-cli-contracts.bats</files>
  <action>
Create tests/intg-cli-contracts.bats with the following structure:

1. **File-level setup (free code, runs at parse time):**
   - Compute PROJECT_ROOT via `git rev-parse --show-toplevel` at file level (NOT inside setup/setup_file -- bats_test_function registration happens before those run).
   - Define `_discover_all_scripts()` function: `find "${PROJECT_ROOT}/scripts" -name '*.sh' -not -path '*/lib/*' -not -name 'common.sh' -not -name 'check-docs-completeness.sh' | sort`
   - Define `_discover_execute_mode_scripts()` function: same as above but also excludes `-not -path '*/diagnostics/*' -not -name 'check-tools.sh'` (these 4 scripts have no -x support).

2. **Test function for INTG-01 (help contract):**
   - `_test_help_contract()` takes one arg (script path). Runs `run env NO_COLOR=1 bash "$script" --help`, then `assert_success` and `assert_output --partial "Usage:"`.
   - Pass `--help` as first argument (works for both parse_common_args and old-pattern scripts per Pitfall 6).

3. **Dynamic test registration for INTG-01:**
   - While loop reading from `_discover_all_scripts` output, registers via `bats_test_function --description "INTG-01 ${local_path}: --help exits 0 with Usage" -- _test_help_contract "$script"`.
   - `local_path` strips PROJECT_ROOT prefix for readable test names.

4. **Static meta-tests for INTG-03 (discovery verification):**
   - `@test "INTG-03: discovery finds all testable scripts"` -- runs `_discover_all_scripts | wc -l`, asserts count >= 67.
   - `@test "INTG-03: execute-mode discovery excludes diagnostics and check-tools"` -- runs `_discover_execute_mode_scripts | wc -l`, asserts count >= 63.

5. **setup() function:**
   - `load 'test_helper/common-setup'` and `_common_setup` (loads assertion libraries and sets NO_COLOR=1).
   - This runs before each test, making assert_success/assert_output available to dynamically registered test functions.

Do NOT add INTG-02 or mock infrastructure yet -- Task 2 handles that. This task proves `bats_test_function` works with our setup before adding complexity.

Expected: 67 INTG-01 tests + 2 INTG-03 meta-tests = 69 new tests.
  </action>
  <verify>
Run `make test 2>&1 | tail -10` -- should show 124 total tests (55 existing + 69 new), all passing.
Run `make test 2>&1 | grep -c "INTG-01"` -- should output 67.
Run `make test 2>&1 | grep -c "INTG-03"` -- should output 2.
  </verify>
  <done>All 67 scripts pass the --help contract test. Discovery meta-tests confirm >= 67 total scripts and >= 63 execute-mode scripts. bats_test_function dynamic registration is proven to work in this project.</done>
</task>

<task type="auto">
  <name>Task 2: Add execute-mode rejection tests with mock commands (INTG-02, INTG-04)</name>
  <files>tests/intg-cli-contracts.bats</files>
  <action>
Extend tests/intg-cli-contracts.bats to add INTG-02 and INTG-04:

1. **Mock infrastructure in setup_file() (INTG-04):**
   - Add `setup_file()` function. Create `MOCK_BIN="${BATS_FILE_TMPDIR}/mock-bin"` directory.
   - Define the full list of 19 tools that scripts may require: nmap, tshark, msfconsole, msfvenom, aircrack-ng, hashcat, skipfish, sqlmap, hping3, john, nikto, foremost, dig, curl, nc, traceroute, mtr, gobuster, ffuf.
   - For each tool, check `if ! command -v "$tool" &>/dev/null` -- only create mock if tool is NOT already installed. Create mock as `printf '#!/bin/sh\nexit 0\n' > "${MOCK_BIN}/${tool}"` then `chmod +x`.
   - Export MOCK_BIN so setup() can access it.

2. **Update setup() to prepend mock bin to PATH:**
   - Add `export PATH="${MOCK_BIN}:${PATH}"` in setup() AFTER the existing _common_setup call.
   - The `if` guard in setup_file ensures real tools are preferred; mocks only fill gaps.

3. **Test function for INTG-02 (execute-mode rejection):**
   - `_test_execute_mode_rejects_pipe()` takes one arg (script path). Runs: `run bash -c "echo '' | NO_COLOR=1 bash '$script' -x dummy_target 2>&1"`.
   - The pipe makes stdin non-interactive. `-x` activates execute mode. `dummy_target` satisfies require_target for scripts that need it (the 11 examples.sh scripts with require_target -- extra arg is harmless for scripts that don't need it).
   - Assert: `assert_failure` and `assert_output --partial "interactive terminal"`.

4. **Dynamic test registration for INTG-02:**
   - While loop reading from `_discover_execute_mode_scripts`, registers via `bats_test_function --description "INTG-02 ${local_path}: -x rejects piped stdin" -- _test_execute_mode_rejects_pipe "$script"`.

5. **Important ordering:** The INTG-02 registration loop must come AFTER the INTG-01 registration loop (both are free code at file level). The static INTG-03 @test functions can be anywhere since they use standard @test syntax.

Expected: 63 additional INTG-02 tests. Grand total: 55 (existing) + 67 (INTG-01) + 63 (INTG-02) + 2 (INTG-03) = 187 tests.

Note on INTG-01 and mocks: The --help tests do NOT need mocks because --help is processed before require_cmd in both script patterns. However, adding MOCK_BIN to PATH in setup() is harmless and provides defense-in-depth -- if a script pattern ever changes, the mocks prevent spurious failures.
  </action>
  <verify>
Run `make test 2>&1 | tail -5` -- should show 187 total tests, all passing.
Run `make test 2>&1 | grep -c "INTG-02"` -- should output 63.
Run `make test 2>&1 | grep "INTG-02" | head -3` to verify test names include script paths.
Test the CI mock scenario by temporarily hiding a tool: `(PATH=$(echo "$PATH" | tr ':' '\n' | grep -v nmap | tr '\n' ':') make test 2>&1 | grep "nmap" | head -3)` -- nmap tests should still pass via mocks.
  </verify>
  <done>All 63 execute-mode scripts reject piped stdin with -x flag. Mock commands created for all 19 tools (only for tools not already installed). Total test suite: 187 tests passing. All four INTG requirements satisfied.</done>
</task>

</tasks>

<verification>
1. `make test` passes with 187 total tests (55 existing + 132 new)
2. Every INTG-01 test shows individual script path in TAP output
3. Every INTG-02 test shows individual script path in TAP output
4. INTG-03 meta-tests confirm dynamic discovery counts
5. Tests work with and without pentesting tools installed (mocks fill gaps)
6. No hardcoded script paths in the test file (only find-based discovery)
</verification>

<success_criteria>
- 67 INTG-01 help contract tests pass (one per testable script)
- 63 INTG-02 execute-mode rejection tests pass (one per parse_common_args script)
- 2 INTG-03 discovery verification meta-tests pass
- Mock commands exist for 19 tools (created only when tool is missing)
- Total test count: 187 (auto-grows when new scripts are added)
- `make test` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/20-script-integration-tests/20-01-SUMMARY.md`
</output>
