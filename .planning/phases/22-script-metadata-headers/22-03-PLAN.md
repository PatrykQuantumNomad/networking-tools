---
phase: 22-script-metadata-headers
plan: 03
type: execute
wave: 2
depends_on: [22-01, 22-02]
files_modified:
  - tests/intg-script-headers.bats
autonomous: true

must_haves:
  truths:
    - "BATS test validates every .sh file in scripts/ has @description, @usage, and @dependencies"
    - "Test uses dynamic discovery -- adding a new .sh file automatically includes it"
    - "Test checks fields appear in the first 10 lines of each file"
    - "All existing tests still pass (zero regressions from header additions)"
  artifacts:
    - path: "tests/intg-script-headers.bats"
      provides: "HDR-06 validation test for script metadata headers"
      contains: "@description"
  key_links:
    - from: "tests/intg-script-headers.bats"
      to: "scripts/**/*.sh"
      via: "find-based discovery + head -10 + grep"
      pattern: "bats_test_function"
---

<objective>
Create a BATS validation test that verifies every .sh file in scripts/ has the required metadata header fields. This covers HDR-06.

Purpose: Enforce header conformance in CI -- any new script without proper headers will fail the test suite.
Output: `tests/intg-script-headers.bats` with dynamic per-file test registration.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-script-metadata-headers/22-RESEARCH.md
@tests/intg-cli-contracts.bats
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BATS validation test for script metadata headers (HDR-06)</name>
  <files>
    tests/intg-script-headers.bats
  </files>
  <action>
    Create `tests/intg-script-headers.bats` following the same patterns as `tests/intg-cli-contracts.bats`.

    **Structure:**
    1. File header comment with HDR-06 reference
    2. `PROJECT_ROOT` set via `git rev-parse --show-toplevel`
    3. Required fields array: `('# @description' '# @usage' '# @dependencies')`
    4. `_discover_all_sh_files()` function using `find "${PROJECT_ROOT}/scripts" -name '*.sh' | sort`
    5. `_test_header_fields()` function that takes a script path and:
       - For each required field pattern, runs `head -10 "$1" | grep -c "$field"`
       - Asserts success (exit 0) and output >= 1 (at least one match)
    6. Dynamic test registration loop using `bats_test_function`:
       ```
       while IFS= read -r script; do
           local_path="${script#"${PROJECT_ROOT}"/}"
           bats_test_function \
               --description "HDR-06 ${local_path}: has required header fields" \
               -- _test_header_fields "$script"
       done < <(_discover_all_sh_files)
       ```
    7. Meta-test: `@test "HDR-06: discovery finds all script files"` asserting count >= 78
    8. `setup()` function loading `test_helper/common-setup` and calling `_common_setup`

    **Key details:**
    - Use `head -10` (not full file grep) to ensure fields are in the header, not buried deep in the file
    - Use `grep -c` (count) pattern from research -- `run` + `assert_success` + `assert [ "$output" -ge 1 ]`
    - The test function checks ALL three required fields for a single script file
    - No `setup_file` or `teardown_file` needed -- this test only reads files, no side effects
    - No mock binaries needed -- just file content inspection

    **Do NOT:**
    - Validate border lines (`# ====...====`) -- borders are visual aids, not requirements
    - Validate field content/values -- only presence matters
    - Use `grep` on the full file -- use `head -10` to enforce position
  </action>
  <verify>
    `bats tests/intg-script-headers.bats` — all tests pass (78+ individual HDR-06 tests + 1 meta-test).
    `bats tests/` — full test suite passes with no regressions.
  </verify>
  <done>
    `tests/intg-script-headers.bats` exists, registers one test per .sh file dynamically, validates @description/@usage/@dependencies presence in first 10 lines, and passes on all 78 scripts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite to verify zero regressions from all header additions</name>
  <files>(no files modified -- verification only)</files>
  <action>
    Run the complete BATS test suite to confirm that all headers added in plans 22-01 and 22-02 caused zero behavioral regressions.

    **Commands to run:**
    1. `bats tests/` -- full suite including unit tests, CLI contract tests, and the new header validation test
    2. If any failures: diagnose and fix. Common issues:
       - Syntax error from a missing `#` prefix in a header line
       - Header placed after the `source` line (fields not in first 10 lines)
       - Typo in field name (e.g., `@desc` instead of `@description`)

    **Expected results:**
    - All existing unit tests (Phase 19) pass
    - All CLI contract tests (Phase 20) pass -- headers are comments, so --help output and -x behavior unchanged
    - All new HDR-06 header tests pass
    - Zero test failures
  </action>
  <verify>
    `bats tests/` exits 0 with all tests passing.
    No test output contains "not ok" (TAP failure indicator).
  </verify>
  <done>
    Full BATS test suite passes. Zero regressions from header additions. HDR-06 validation confirms all 78 scripts have conformant headers.
  </done>
</task>

</tasks>

<verification>
1. `bats tests/intg-script-headers.bats` -- all 79+ tests pass (78 per-file + 1 meta-test).
2. `bats tests/` -- full suite passes with zero failures.
3. `wc -l tests/intg-script-headers.bats` -- file exists and is non-trivial.
</verification>

<success_criteria>
- `tests/intg-script-headers.bats` exists with dynamic per-file test registration
- Every .sh file in scripts/ is discovered and validated
- All three required fields (@description, @usage, @dependencies) are verified in first 10 lines
- Full BATS test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/22-script-metadata-headers/22-03-SUMMARY.md`
</output>
