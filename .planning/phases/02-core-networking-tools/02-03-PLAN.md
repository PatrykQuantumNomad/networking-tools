---
phase: 02-core-networking-tools
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - scripts/common.sh
  - scripts/netcat/examples.sh
  - scripts/netcat/scan-ports.sh
  - scripts/netcat/setup-listener.sh
  - scripts/netcat/transfer-files.sh
  - scripts/check-tools.sh
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Running bash scripts/netcat/examples.sh 127.0.0.1 prints 10 numbered examples that identify the local netcat variant (OpenBSD/GNU/ncat) and label variant-specific flags"
    - "Running bash scripts/netcat/scan-ports.sh prints educational examples for basic TCP port scanning with nc -z"
    - "Running bash scripts/netcat/setup-listener.sh prints educational examples for listening on ports"
    - "Running bash scripts/netcat/transfer-files.sh prints educational examples for sending/receiving files over TCP"
    - "make check detects nc as installed/missing alongside all other tools including dig and curl"
    - "detect_nc_variant function exists in common.sh and correctly identifies the local netcat variant"
  artifacts:
    - path: "scripts/common.sh"
      provides: "detect_nc_variant() function"
      contains: "detect_nc_variant"
    - path: "scripts/netcat/examples.sh"
      provides: "10 variant-aware netcat examples following Pattern A"
      contains: "NC_VARIANT"
    - path: "scripts/netcat/scan-ports.sh"
      provides: "Port scanning use-case with nc -z"
      contains: "require_cmd nc"
    - path: "scripts/netcat/setup-listener.sh"
      provides: "Listener setup use-case"
      contains: "nc -l"
    - path: "scripts/netcat/transfer-files.sh"
      provides: "File transfer use-case"
      contains: "require_cmd nc"
    - path: "scripts/check-tools.sh"
      provides: "nc detection with variant info"
      contains: "[nc]="
    - path: "Makefile"
      provides: "netcat and use-case make targets"
      contains: "scripts/netcat/examples.sh"
  key_links:
    - from: "scripts/netcat/examples.sh"
      to: "scripts/common.sh"
      via: "source directive and detect_nc_variant call"
      pattern: "detect_nc_variant"
    - from: "scripts/check-tools.sh"
      to: "nc"
      via: "TOOLS array entry and get_version case"
      pattern: "\\[nc\\]="
    - from: "Makefile"
      to: "scripts/netcat/examples.sh"
      via: "make target"
      pattern: "bash scripts/netcat/examples\\.sh"
---

<objective>
Add the detect_nc_variant() function to common.sh, create the netcat tool directory with variant-aware examples.sh and three use-case scripts (scan-ports, setup-listener, transfer-files), and integrate nc into check-tools.sh and Makefile.

Purpose: Third and most complex networking tool. Netcat is the "TCP/IP swiss army knife" but has four incompatible variants. Variant detection and proper flag labeling are the primary engineering challenges.
Output: detect_nc_variant() in common.sh, 4 executable bash scripts in scripts/netcat/, updated check-tools.sh and Makefile.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-networking-tools/02-RESEARCH.md
@.planning/phases/02-core-networking-tools/02-01-SUMMARY.md
@.planning/phases/02-core-networking-tools/02-02-SUMMARY.md
@scripts/common.sh
@scripts/nmap/examples.sh
@scripts/nmap/discover-live-hosts.sh
@scripts/check-tools.sh
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add detect_nc_variant() to common.sh and create netcat scripts</name>
  <files>
    scripts/common.sh
    scripts/netcat/examples.sh
    scripts/netcat/scan-ports.sh
    scripts/netcat/setup-listener.sh
    scripts/netcat/transfer-files.sh
  </files>
  <action>
**common.sh addition:**

Add `detect_nc_variant()` function to scripts/common.sh. Place it after the existing utility functions and before the diagnostic report functions section (before the `# --- Diagnostic Report Functions ---` comment). Add a section comment:

```bash
# --- Netcat Variant Detection ---
# Identifies which netcat implementation is installed (ncat, gnu, traditional, openbsd)
# Used by scripts/netcat/ scripts to label variant-specific flags

detect_nc_variant() {
    local help_text
    help_text=$(nc -h 2>&1 || true)
    if echo "$help_text" | grep -qi 'ncat'; then
        echo "ncat"
    elif echo "$help_text" | grep -qi 'gnu'; then
        echo "gnu"
    elif echo "$help_text" | grep -qi 'connect to somewhere'; then
        echo "traditional"
    else
        # OpenBSD nc (including macOS Apple fork) -- detected by exclusion
        echo "openbsd"
    fi
}
```

**Key design decisions for detect_nc_variant():**
- Uses `nc -h 2>&1 || true` because nc -h may exit non-zero on some variants, and set -e is active
- ncat check first (most specific), then GNU, then traditional (which has "connect to somewhere" banner)
- OpenBSD/macOS detected by exclusion (Apple fork does not self-identify)
- Case-insensitive grep (-qi) for robustness

**examples.sh** (Pattern A with variant detection):
- Shebang, comment: `# netcat/examples.sh -- netcat (nc): TCP/UDP networking swiss-army knife`
- Source common.sh
- show_help() with Usage, description, examples (127.0.0.1, 192.168.1.1)
- Help flag check
- `require_cmd nc "apt install netcat-openbsd (Debian/Ubuntu) | brew install netcat (macOS)"`
- `require_target "${1:-}"`
- `safety_banner`
- `TARGET="$1"`
- Detect variant: `NC_VARIANT=$(detect_nc_variant)`
- Header: `info "=== Netcat Examples ==="`, `info "Target: ${TARGET}"`, `info "Detected variant: ${NC_VARIANT}"`
- 10 numbered examples. Examples 1-7 use universal flags only. Examples 8-10 use variant-conditional logic:
  1. Test if a port is open: `nc -zv ${TARGET} 80`
  2. Scan a range of ports: `nc -zv ${TARGET} 20-100`
  3. Start a simple listener: `nc -l -p 4444` (note: on OpenBSD, -p is optional with -l)
  4. Connect to a remote port: `nc -v ${TARGET} 80`
  5. Send UDP packet: `nc -u ${TARGET} 53`
  6. Set connection timeout: `nc -w 3 -zv ${TARGET} 80`
  7. Simple chat between two machines (listener + connector)
  8. [VARIANT-SPECIFIC] Keep listener open for multiple connections:
     - ncat: `ncat -k -l -p 4444`
     - openbsd: `nc -k -l 4444`
     - gnu/traditional: explain that -k is not available, use a while loop
  9. [VARIANT-SPECIFIC] Execute command on connection:
     - ncat: `ncat -e /bin/bash -l -p 4444`
     - traditional: `nc -e /bin/bash -l -p 4444`
     - openbsd: explain that -e is NOT available, show named pipe alternative: `mkfifo /tmp/f; nc -l 4444 < /tmp/f | /bin/sh > /tmp/f 2>&1`
     - gnu: `nc -c /bin/bash -l -p 4444`
  10. Transfer a file over TCP (listener + sender)
- Interactive demo: `nc -zv ${TARGET} 80 -w 3` (port scan with timeout -- completes quickly, safe). Do NOT use a listener for the demo (would block indefinitely per PITFALL-6 in research).
- chmod +x

**scan-ports.sh** (Use-case pattern):
- Source common.sh, show_help, require_cmd nc
- `TARGET="${1:-127.0.0.1}"`
- Detect variant: `NC_VARIANT=$(detect_nc_variant)`
- safety_banner, header showing target and variant
- Educational context: "Why use netcat for port scanning?" explaining nc -z vs nmap, when nc is preferable (quick check, no nmap available)
- 10 examples: (1) Scan single port, (2) Scan port range 20-100, (3) Scan common web ports 80,443, (4) Scan with timeout -w 2, (5) UDP port scan -u, (6) Verbose scan -v, (7) Scan top service ports one-by-one in a loop, (8) Suppress DNS resolution -n for speed, (9) Scan and grep for open ports from output, (10) Quick check if specific service is running
- Interactive demo: `nc -zv ${TARGET} 80 -w 3` (quick, bounded)

**setup-listener.sh** (Use-case pattern):
- Source common.sh, show_help, require_cmd nc
- No target required -- listeners bind locally. Use `PORT="${1:-4444}"` as default.
- Detect variant: `NC_VARIANT=$(detect_nc_variant)`
- safety_banner, header showing port and variant
- Educational context: "Why set up a listener?" explaining reverse shells, file transfer, debugging
- 10 examples with variant labels where needed: (1) Basic listener on port, (2) Listener with verbose output, (3) [VARIANT] Keep-alive listener -k, (4) Listener that saves to file, (5) UDP listener, (6) Listener with timeout, (7) [VARIANT] Execute command on connect, (8) Listener for HTTP-like response, (9) Two-way chat setup, (10) Listener piped to another command
- Interactive demo: SKIP listener demo (would block). Instead demo a quick port scan: `nc -zv 127.0.0.1 22 -w 2` to show nc works.

**transfer-files.sh** (Use-case pattern):
- Source common.sh, show_help, require_cmd nc
- `TARGET="${1:-127.0.0.1}"`
- Detect variant: `NC_VARIANT=$(detect_nc_variant)`
- safety_banner, header showing target and variant
- Educational context: "Why use netcat for file transfer?" explaining simplicity vs scp/rsync, when nc is useful (no SSH, quick ad-hoc transfer)
- 10 examples: (1) Send file: receiver listens, sender connects, (2) Receive file, (3) Transfer with progress (pipe through pv), (4) Send directory via tar pipe, (5) [VARIANT] Use -N to close after EOF (OpenBSD), (6) Transfer with compression (gzip pipe), (7) Verify transfer with checksum, (8) Transfer multiple files via tar, (9) Set timeout for stale transfers, (10) Encrypted transfer via openssl pipe
- Interactive demo: Show the commands but explain that file transfer requires two terminals. Offer to demo port connectivity instead.

All four scripts must be chmod +x.
  </action>
  <verify>
Test detect_nc_variant works:
```
bash -c 'source scripts/common.sh; detect_nc_variant'
```
Expected: One of "ncat", "gnu", "traditional", "openbsd"

Run each script with --help flag:
```
bash scripts/netcat/examples.sh --help
bash scripts/netcat/scan-ports.sh --help
bash scripts/netcat/setup-listener.sh --help
bash scripts/netcat/transfer-files.sh --help
```
Expected: All exit 0.

Run examples.sh with a target in non-interactive mode and count 10 examples:
```
echo "" | bash scripts/netcat/examples.sh 127.0.0.1 2>&1 | grep -c "^\\[INFO\\].*[0-9]*)"
```
Expected: 10

Verify variant detection is displayed:
```
echo "" | bash scripts/netcat/examples.sh 127.0.0.1 2>&1 | grep -i "variant"
```
Expected: Line containing "Detected variant:" with a value.
  </verify>
  <done>
detect_nc_variant() exists in common.sh and returns a valid variant string. All four netcat scripts exist, are executable, display the detected variant, print 10 numbered examples with variant-specific flags labeled, and exit cleanly with --help.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate nc into check-tools.sh and Makefile</name>
  <files>
    scripts/check-tools.sh
    Makefile
  </files>
  <action>
**check-tools.sh changes:**

1. Add nc to the TOOLS associative array:
   ```
   [nc]="apt install netcat-openbsd (Debian/Ubuntu) | brew install netcat (macOS)"
   ```

2. Add `nc` to the TOOL_ORDER array after `curl`:
   ```
   TOOL_ORDER=(nmap tshark msfconsole aircrack-ng hashcat skipfish sqlmap hping3 john nikto foremost dig curl nc)
   ```
   Note: `dig` and `curl` were added by plans 02-01 and 02-02.

3. Add an `nc)` case to the `get_version()` function. nc has NO --version flag -- the existing default case would try `nc --version` which hangs or errors. Instead use `nc -h 2>&1 | head -1`:
   ```bash
   nc)
       nc -h 2>&1 | head -1
       ;;
   ```
   Place this case alongside the dig case, before the `*)` default.

**Makefile changes:**

1. Add to the .PHONY line: `netcat scan-ports nc-listener nc-transfer`

2. Add tool runner target:
   ```makefile
   netcat: ## Run netcat examples (usage: make netcat TARGET=<ip>)
   	@bash scripts/netcat/examples.sh $(TARGET)
   ```

3. Add use-case targets. IMPORTANT: Use `nc-listener` NOT `setup-listener` -- that name is already taken by the metasploit listener target (PITFALL-12 Makefile collision):
   ```makefile
   scan-ports: ## Scan ports with netcat (usage: make scan-ports TARGET=<ip>)
   	@bash scripts/netcat/scan-ports.sh $(or $(TARGET),127.0.0.1)

   nc-listener: ## Setup netcat listener
   	@bash scripts/netcat/setup-listener.sh

   nc-transfer: ## Transfer files with netcat
   	@bash scripts/netcat/transfer-files.sh
   ```

Note: nc-listener and nc-transfer do not use $(TARGET) because listeners bind locally and transfer scripts explain the two-terminal setup.

IMPORTANT: Makefile recipes MUST use actual tab characters for indentation, not spaces.
  </action>
  <verify>
```
make help 2>&1 | grep -E "netcat|scan-ports|nc-listener|nc-transfer"
```
Expected: 4 lines showing the new targets.

Verify no collision with existing setup-listener:
```
make help 2>&1 | grep "setup-listener"
```
Expected: Shows metasploit's setup-listener (unchanged).

```
bash scripts/check-tools.sh 2>&1 | grep -i nc
```
Expected: Shows nc with usage/version info.

Verify full tool count:
```
bash scripts/check-tools.sh 2>&1 | grep -E "^.*(OK|WARN).*" | wc -l
```
Expected: 14 tools total (11 original + dig + curl + nc).
  </verify>
  <done>
`make check` shows nc in the tool list with variant info from nc -h. `make help` shows netcat, scan-ports, nc-listener, nc-transfer targets. No collision with existing setup-listener. Total tool count is 14.
  </done>
</task>

</tasks>

<verification>
1. detect_nc_variant() function exists in common.sh and returns valid variant
2. All four netcat scripts exist and are executable: `ls -la scripts/netcat/*.sh`
3. `bash scripts/netcat/examples.sh 127.0.0.1` prints 10 examples with variant detection
4. Variant-specific flags are labeled with the variant name
5. `make check` includes nc in its output (14 tools total)
6. `make help` shows netcat, scan-ports, nc-listener, nc-transfer
7. Existing `setup-listener` target still works for metasploit (no collision)
8. No interactive demos use blocking listeners (PITFALL-6 safety)
</verification>

<success_criteria>
- detect_nc_variant() in common.sh correctly identifies the local netcat variant
- scripts/netcat/examples.sh prints 10 numbered examples showing the detected variant and labeling variant-specific flags
- Three use-case scripts (scan-ports, setup-listener, transfer-files) each print 10 numbered examples with variant awareness
- check-tools.sh detects nc and displays its help line (since nc has no --version)
- Makefile has working targets using nc-listener and nc-transfer (avoiding setup-listener collision)
- All scripts follow established patterns (source common.sh, show_help, safety_banner)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-networking-tools/02-03-SUMMARY.md`
</output>
