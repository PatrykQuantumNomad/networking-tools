---
phase: 17-shellcheck-compliance-and-ci
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lib/colors.sh
  - scripts/lib/output.sh
  - scripts/lib/args.sh
  - scripts/dig/check-dns-propagation.sh
  - tests/test-arg-parsing.sh
  - tests/test-library-loads.sh
  - Makefile
  - .github/workflows/shellcheck.yml
autonomous: true

must_haves:
  truths:
    - "shellcheck --severity=warning returns exit 0 on every .sh file in the repository"
    - "make lint runs ShellCheck validation and reports pass/fail"
    - "A PR that introduces a ShellCheck warning fails the ShellCheck CI check"
    - "No local var=$(cmd) patterns exist (SC2155 already resolved)"
  artifacts:
    - path: "scripts/lib/colors.sh"
      provides: "SC2034 disable directives for color variables"
      contains: "shellcheck disable=SC2034"
    - path: "scripts/lib/output.sh"
      provides: "SC2034 disable directive for PROJECT_ROOT"
      contains: "shellcheck disable=SC2034"
    - path: "scripts/lib/args.sh"
      provides: "SC2034 disable directive for LOG_LEVEL"
      contains: "shellcheck disable=SC2034"
    - path: ".github/workflows/shellcheck.yml"
      provides: "CI workflow that gates PRs on ShellCheck compliance"
      contains: "shellcheck --severity=warning"
    - path: "Makefile"
      provides: "lint target for local ShellCheck validation"
      contains: "lint:"
  key_links:
    - from: ".github/workflows/shellcheck.yml"
      to: ".shellcheckrc"
      via: "ShellCheck walks up from script directory to find config"
      pattern: "shellcheck --severity=warning"
    - from: "Makefile"
      to: ".github/workflows/shellcheck.yml"
      via: "Identical find + shellcheck commands ensure local = CI behavior"
      pattern: "find.*shellcheck.*severity=warning"
---

<objective>
Fix all 11 ShellCheck warnings across 6 files, add a `make lint` target, and create a GitHub Actions workflow that gates PRs on ShellCheck compliance.

Purpose: Complete the v1.2 Script Hardening milestone by ensuring every script passes static analysis with CI enforcement preventing regressions.
Output: Zero ShellCheck warnings, `make lint` target, `.github/workflows/shellcheck.yml` CI gate.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-shellcheck-compliance-and-ci/17-RESEARCH.md
@scripts/lib/colors.sh
@scripts/lib/output.sh
@scripts/lib/args.sh
@scripts/dig/check-dns-propagation.sh
@tests/test-arg-parsing.sh
@tests/test-library-loads.sh
@Makefile
@.shellcheckrc
@.github/workflows/deploy-site.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all 11 ShellCheck warnings across 6 files</name>
  <files>
    scripts/lib/colors.sh
    scripts/lib/output.sh
    scripts/lib/args.sh
    scripts/dig/check-dns-propagation.sh
    tests/test-arg-parsing.sh
    tests/test-library-loads.sh
  </files>
  <action>
Fix all 11 ShellCheck SC2034/SC2043 warnings using targeted inline directives. Do NOT add global disables to .shellcheckrc.

**scripts/lib/colors.sh** (SC2034 x6 -- color vars appear unused):
Add `# shellcheck disable=SC2034` before each color variable assignment on lines 10-15. These vars are used by 60+ sourcing scripts but ShellCheck cannot trace cross-file usage. Also add the same directive before each re-assignment inside the `if` block (lines 19-24) since the directive only covers the next code construct. Add a single comment at the top of the variable block explaining why: "Color variables used by sourcing scripts via common.sh".

**scripts/lib/output.sh** (SC2034 x1 -- PROJECT_ROOT appears unused):
Add `# shellcheck disable=SC2034` before line 25 (`PROJECT_ROOT=...`). Add comment: "Used by sourcing scripts for wordlist/sample paths".

**scripts/lib/args.sh** (SC2034 x1 -- LOG_LEVEL appears unused):
Add `# shellcheck disable=SC2034` before the `LOG_LEVEL="warn"` assignment inside the `-q|--quiet` case branch (line 37). Add comment: "Used by logging.sh _should_log()". Also check the `-v|--verbose` branch -- `LOG_LEVEL="debug"` on line 34 may need the same directive.

**scripts/dig/check-dns-propagation.sh** (SC2034 x1 -- RESOLVERS genuinely unused):
Remove the unused `RESOLVERS` array declaration on line 46. Keep the comment block above it (lines 43-45) explaining which resolvers are used, as that context is still valuable for the reader.

**tests/test-arg-parsing.sh** (SC2034 x1 -- order_output unused):
On line 166, prefix the variable with underscore: `_order_output=$(...)`. This signals intentional discard -- only the exit code `order_exit` on line 167 is checked.

**tests/test-library-loads.sh** (SC2043 x1 -- single-item for loop):
Replace the single-iteration loop on lines 87-93 with a direct if/else. Instead of `for fn in detect_nc_variant; do ... done`, write:
```
if declare -F "detect_nc_variant" > /dev/null 2>&1; then
    check_pass "detect_nc_variant() is defined"
else
    check_fail "detect_nc_variant() is NOT defined"
fi
```

After all fixes, run `shellcheck --severity=warning` on all .sh files to confirm zero warnings remain.
  </action>
  <verify>
Run: `find /Users/patrykattc/work/git/networking-tools -name '*.sh' -not -path './site/*' -not -path './.planning/*' -not -path './node_modules/*' -exec shellcheck --severity=warning {} +`
Expected: Exit code 0, no warnings printed.
Also run: `bash /Users/patrykattc/work/git/networking-tools/tests/test-arg-parsing.sh` and `bash /Users/patrykattc/work/git/networking-tools/tests/test-library-loads.sh` to confirm no regressions.
  </verify>
  <done>
shellcheck --severity=warning returns exit 0 across all 81 .sh files. Existing test scripts still pass. No SC2034 or SC2043 warnings remain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add make lint target and GitHub Actions ShellCheck workflow</name>
  <files>
    Makefile
    .github/workflows/shellcheck.yml
  </files>
  <action>
**Makefile** -- Add a `lint` target:
1. Add `lint` to the `.PHONY` declaration on line 3.
2. Add the target after the `help` target (before `wordlists`), grouped with other project-level commands:
```makefile
lint: ## Run ShellCheck on all shell scripts
	@echo "Running ShellCheck (severity=warning)..."
	@find . -name '*.sh' -not -path './site/*' -not -path './.planning/*' -not -path './node_modules/*' -exec shellcheck --severity=warning {} +
	@echo "All scripts pass ShellCheck."
```
The `find` command MUST use identical exclusion paths as the CI workflow to prevent divergence (Pitfall 4 from research).

**Create .github/workflows/shellcheck.yml** -- GitHub Actions workflow:
```yaml
name: ShellCheck

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  shellcheck:
    name: Lint shell scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run ShellCheck
        run: |
          echo "ShellCheck version:"
          shellcheck --version
          echo ""
          find . -name '*.sh' \
            -not -path './site/*' \
            -not -path './.planning/*' \
            -not -path './node_modules/*' \
            -exec shellcheck --severity=warning {} +
          echo "All scripts pass ShellCheck."
```
Use `actions/checkout@v5` to match the existing `deploy-site.yml` pattern. ShellCheck is pre-installed on `ubuntu-latest` -- do NOT use third-party actions. Print ShellCheck version for visibility. Use identical `find` exclusions as the Makefile target.
  </action>
  <verify>
Run: `make lint` from repository root. Expected: "Running ShellCheck..." then "All scripts pass ShellCheck." with exit 0.
Verify: `make help` includes the lint target in its output.
Verify: `.github/workflows/shellcheck.yml` exists and is valid YAML (run `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/shellcheck.yml'))"` or similar).
  </verify>
  <done>
`make lint` runs ShellCheck on all .sh files and passes. `.github/workflows/shellcheck.yml` exists with PR gating on main branch. The find commands in Makefile and CI workflow use identical exclusion paths.
  </done>
</task>

</tasks>

<verification>
1. `find . -name '*.sh' -not -path './site/*' -not -path './.planning/*' -not -path './node_modules/*' -exec shellcheck --severity=warning {} +` exits 0
2. `make lint` exits 0 with "All scripts pass ShellCheck."
3. `bash tests/test-arg-parsing.sh` passes (no regressions from _order_output rename)
4. `bash tests/test-library-loads.sh` passes (no regressions from loop unwrap)
5. `.github/workflows/shellcheck.yml` triggers on PRs to main
6. `grep -r 'local.*=\$(' scripts/` returns zero matches (SC2155 confirmed clean)
</verification>

<success_criteria>
- shellcheck --severity=warning returns exit 0 on all .sh files (LINT-01)
- Zero SC2155 violations confirmed (LINT-02)
- make lint runs ShellCheck and reports results (LINT-03)
- GitHub Actions workflow gates PRs on ShellCheck compliance (LINT-04)
- All existing tests pass without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-shellcheck-compliance-and-ci/17-01-SUMMARY.md`
</output>
