---
phase: 21-ci-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/tests.yml]
autonomous: true

must_haves:
  truths:
    - "Pushing to main or opening a PR triggers the BATS test suite automatically"
    - "Test failures appear as GitHub annotations on the PR via JUnit XML report"
    - "BATS tests and ShellCheck linting run independently (neither blocks the other)"
  artifacts:
    - path: ".github/workflows/tests.yml"
      provides: "BATS CI workflow with JUnit reporting"
      contains: "bats-core/bats-action@4.0.0"
  key_links:
    - from: ".github/workflows/tests.yml"
      to: "tests/*.bats"
      via: "bats tests/ command in workflow run step"
      pattern: "bats tests/"
    - from: ".github/workflows/tests.yml"
      to: "mikepenz/action-junit-report"
      via: "report.xml output consumed by reporting step"
      pattern: "report_paths.*report\\.xml"
---

<objective>
Create a GitHub Actions workflow that runs the full BATS test suite on every push and PR, generates JUnit XML reports, and publishes test results as PR annotations.

Purpose: Automated test enforcement ensures regressions are caught before merge. JUnit annotations surface failures directly on the PR without digging through logs.
Output: `.github/workflows/tests.yml` -- a complete, working CI workflow
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-ci-integration/21-RESEARCH.md
@.github/workflows/shellcheck.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BATS CI workflow with JUnit reporting</name>
  <files>.github/workflows/tests.yml</files>
  <action>
Create `.github/workflows/tests.yml` with the following exact structure (verified in 21-RESEARCH.md):

```yaml
name: Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  checks: write

jobs:
  bats:
    name: BATS test suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup BATS
        uses: bats-core/bats-action@4.0.0
        with:
          bats-version: 1.13.0
          support-install: false
          assert-install: false
          detik-install: false
          file-install: false

      - name: Run BATS tests
        run: bats tests/ --report-formatter junit --output "$RUNNER_TEMP" --timing
        env:
          TERM: xterm

      - name: Publish test results
        uses: mikepenz/action-junit-report@v6
        if: always()
        with:
          report_paths: '${{ runner.temp }}/report.xml'
```

Critical details (do NOT deviate):
- `submodules: recursive` -- required to populate bats-core and helper library submodules
- `bats-action@4.0.0` with `bats-version: 1.13.0` -- pin exact versions matching submodules
- All library installs disabled (`support-install: false`, etc.) -- submodules provide libraries at pinned versions
- `bats tests/` WITHOUT `--recursive` -- avoids bats-core internal test fixtures in `tests/bats/test/`
- `--report-formatter junit` (NOT `--formatter junit`) -- writes JUnit to file while keeping terminal output
- `--output "$RUNNER_TEMP"` -- writes `report.xml` to GitHub Actions temp directory
- `TERM: xterm` -- prevents terminal detection issues in CI
- `if: always()` on publish step -- ensures report runs even when tests fail
- `checks: write` permission -- required for action-junit-report to create Check Runs
- Triggers match shellcheck.yml: `push: [main]` and `pull_request: [main]`
  </action>
  <verify>
1. File exists: `test -f .github/workflows/tests.yml`
2. YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/tests.yml'))"`
3. Contains required elements: grep for `bats-action@4.0.0`, `submodules: recursive`, `report-formatter junit`, `if: always()`, `checks: write`, `TERM: xterm`
4. Does NOT contain `--recursive` flag on bats command (would pick up bats internal fixtures)
5. Triggers match shellcheck.yml (push main, pull_request main)
  </verify>
  <done>`.github/workflows/tests.yml` exists with all required CI-01/CI-02/CI-03 elements and is valid YAML</done>
</task>

<task type="auto">
  <name>Task 2: Validate workflow satisfies all three requirements</name>
  <files>.github/workflows/tests.yml</files>
  <action>
Run explicit checks against all three phase requirements:

**CI-01 check:** Workflow uses `bats-core/bats-action@4.0.0` with `bats-version: 1.13.0`. Triggers on push to main and pull_request to main.

**CI-02 check:** Workflow generates JUnit XML via `--report-formatter junit --output "$RUNNER_TEMP"` and publishes via `mikepenz/action-junit-report@v6` with `report_paths: '${{ runner.temp }}/report.xml'`. The `if: always()` ensures the report step runs even on test failure.

**CI-03 check:** The new `tests.yml` is a SEPARATE file from `shellcheck.yml`. No `needs:` dependencies between them. Both trigger on the same events independently. Verify `shellcheck.yml` is unchanged (no modifications).

Also verify:
- No `--recursive` flag on bats command
- All bats-action library installs are disabled (4 flags: support, assert, detik, file)
- `checks: write` permission is present
- `TERM: xterm` env is set

If any check fails, fix the workflow file before marking complete.
  </action>
  <verify>
1. `grep -q 'bats-core/bats-action@4.0.0' .github/workflows/tests.yml` (CI-01)
2. `grep -q 'report-formatter junit' .github/workflows/tests.yml` (CI-02)
3. `grep -q 'action-junit-report' .github/workflows/tests.yml` (CI-02)
4. `diff .github/workflows/shellcheck.yml` shows no changes (CI-03)
5. `! grep -q '\-\-recursive' .github/workflows/tests.yml` (anti-pattern avoidance)
  </verify>
  <done>All three requirements (CI-01, CI-02, CI-03) verified with explicit grep checks. ShellCheck workflow is unchanged.</done>
</task>

</tasks>

<verification>
1. `.github/workflows/tests.yml` exists and is valid YAML
2. Workflow uses `bats-core/bats-action@4.0.0` with pinned `bats-version: 1.13.0`
3. Workflow generates JUnit XML via `--report-formatter junit` and publishes via `action-junit-report@v6`
4. `if: always()` ensures report step runs on test failure
5. `checks: write` permission is declared
6. `submodules: recursive` in checkout step
7. NO `--recursive` flag on bats command
8. All bats-action library installs disabled
9. `shellcheck.yml` is completely unchanged
10. Both workflows trigger on same events (push main, pull_request main)
</verification>

<success_criteria>
A single new file `.github/workflows/tests.yml` satisfies CI-01 (bats-action@4.0.0 runs tests on push/PR), CI-02 (JUnit XML report produces PR annotations), and CI-03 (independent from ShellCheck workflow). No existing files modified.
</success_criteria>

<output>
After completion, create `.planning/phases/21-ci-integration/21-01-SUMMARY.md`
</output>
