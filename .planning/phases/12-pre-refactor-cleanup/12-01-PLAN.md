---
phase: 12-pre-refactor-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/curl/examples.sh
  - scripts/dig/examples.sh
  - scripts/ffuf/examples.sh
  - scripts/ffuf/fuzz-parameters.sh
  - scripts/gobuster/discover-directories.sh
  - scripts/gobuster/enumerate-subdomains.sh
  - scripts/gobuster/examples.sh
  - scripts/hashcat/examples.sh
  - scripts/hping3/examples.sh
  - scripts/john/examples.sh
  - scripts/netcat/examples.sh
  - scripts/nikto/examples.sh
  - scripts/nmap/examples.sh
  - scripts/skipfish/examples.sh
  - scripts/traceroute/compare-routes.sh
  - scripts/traceroute/diagnose-latency.sh
  - scripts/traceroute/examples.sh
  - scripts/traceroute/trace-network-path.sh
  - scripts/tshark/examples.sh
  - scripts/common.sh
  - .shellcheckrc
autonomous: true

must_haves:
  truths:
    - "Every script with an interactive guard uses identical [[ ! -t 0 ]] && exit 0 syntax (zero variant B patterns remain)"
    - "Running any script with Bash 3.x produces a clear version error message mentioning Bash 4.0+ and brew install"
    - "ShellCheck resolves source common.sh paths without SC1091 warnings when run from any directory"
  artifacts:
    - path: ".shellcheckrc"
      provides: "ShellCheck project-level source resolution config"
      contains: "source-path=SCRIPTDIR"
    - path: "scripts/common.sh"
      provides: "Bash 4.0+ version guard before set -euo pipefail"
      contains: "BASH_VERSINFO"
  key_links:
    - from: ".shellcheckrc"
      to: "scripts/*/examples.sh"
      via: "ShellCheck upward directory search finds .shellcheckrc at project root"
      pattern: "source-path=SCRIPTDIR"
    - from: "scripts/common.sh"
      to: "all 66 scripts that source common.sh"
      via: "version guard runs before any Bash 4.0+ syntax"
      pattern: "BASH_VERSINFO\\[0\\] < 4"
---

<objective>
Normalize all interactive guard syntax, add a Bash version guard, and create ShellCheck configuration so the codebase is consistent and ready for the structural changes in Phases 13-17.

Purpose: Phases 13-16 will do bulk migrations across all 66 scripts. Inconsistencies in guard syntax would cause scripts to be missed during find/replace operations. The version guard prevents cryptic failures on macOS's default Bash 3.2. The .shellcheckrc eliminates per-file ShellCheck directives needed in Phase 17.

Output: 19 files with normalized guards, common.sh with version guard, .shellcheckrc at project root.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-pre-refactor-cleanup/12-RESEARCH.md
@scripts/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize interactive guards and comments (NORM-01)</name>
  <files>
    scripts/curl/examples.sh
    scripts/dig/examples.sh
    scripts/ffuf/examples.sh
    scripts/ffuf/fuzz-parameters.sh
    scripts/gobuster/discover-directories.sh
    scripts/gobuster/enumerate-subdomains.sh
    scripts/gobuster/examples.sh
    scripts/hashcat/examples.sh
    scripts/hping3/examples.sh
    scripts/john/examples.sh
    scripts/netcat/examples.sh
    scripts/nikto/examples.sh
    scripts/nmap/examples.sh
    scripts/skipfish/examples.sh
    scripts/traceroute/compare-routes.sh
    scripts/traceroute/diagnose-latency.sh
    scripts/traceroute/examples.sh
    scripts/traceroute/trace-network-path.sh
    scripts/tshark/examples.sh
  </files>
  <action>
    Change the interactive guard line in exactly these 19 files from variant B to variant A:

    FROM: `[[ -t 0 ]] || exit 0`
    TO:   `[[ ! -t 0 ]] && exit 0`

    Use macOS-compatible sed: `sed -i '' 's/\[\[ -t 0 \]\] || exit 0/[[ ! -t 0 ]] \&\& exit 0/' "$file"`

    Run this on each of the 19 files listed above. Do NOT touch any other files. The 44 files that already use variant A stay unchanged. The 5 files without guards (3 diagnostics, check-tools.sh, check-docs-completeness.sh) must NOT be modified.

    After the guard change, also normalize the comment line immediately above the guard in all 63 scripts (both the 19 just changed and the 44 already correct) to a single standard comment:
    `# Interactive demo (skip if non-interactive)`

    This replaces the 7+ comment variants currently in use. Only change comment lines that are directly above a `[[ ! -t 0 ]] && exit 0` line. If a script has a two-line comment block above the guard (e.g., foremost scripts with `# Non-interactive exit guard` + `# Interactive demo`), replace both lines with the single standard comment.
  </action>
  <verify>
    Run: `grep -rn '\[\[ -t 0 \]\] || exit 0' scripts/` -- must return zero results.
    Run: `grep -rn '\[\[ ! -t 0 \]\] && exit 0' scripts/ | wc -l` -- must return exactly 63.
    Run: `grep -B1 '\[\[ ! -t 0 \]\] && exit 0' scripts/*/examples.sh scripts/*/*.sh | grep -v 'Interactive demo (skip if non-interactive)' | grep -v '\[\[ ! -t 0 \]\]' | grep -v '^--$'` -- should return zero non-standard comment lines above guards.
    Spot-check 3 changed files (scripts/nmap/examples.sh, scripts/ffuf/fuzz-parameters.sh, scripts/traceroute/examples.sh) to confirm the guard line and comment are correct.
  </verify>
  <done>All 63 interactive guards use identical `[[ ! -t 0 ]] && exit 0` syntax with a standardized comment above them. Zero variant B patterns remain. The 5 scripts without guards are untouched.</done>
</task>

<task type="auto">
  <name>Task 2: Add Bash 4.0+ version guard to common.sh (NORM-02)</name>
  <files>scripts/common.sh</files>
  <action>
    Add a Bash version guard at the TOP of scripts/common.sh, BEFORE the existing `set -euo pipefail` line (line 5). Insert it after the shebang and file description comments (after line 3), before `set -euo pipefail`.

    Insert these lines:

    ```
    # --- Bash Version Guard ---
    # Require Bash 4.0+ (associative arrays, mapfile, etc.)
    # Uses only Bash 2.x+ syntax so it prints a clear error on old bash.
    if [[ -z "${BASH_VERSINFO:-}" ]] || ((BASH_VERSINFO[0] < 4)); then
        echo "[ERROR] Bash 4.0+ required (found: ${BASH_VERSION:-unknown})" >&2
        echo "[ERROR] macOS ships Bash 3.2 -- install modern bash: brew install bash" >&2
        exit 1
    fi
    ```

    Add a blank line after the `fi` before `set -euo pipefail`.

    IMPORTANT: The guard itself must only use Bash 2.x/3.x compatible syntax. `[[ ]]`, `(( ))`, and `BASH_VERSINFO` are all available since Bash 2.0, so this is safe. Do NOT use `declare -A`, `mapfile`, or any Bash 4.0+ feature in the guard block.
  </action>
  <verify>
    Run: `/bin/bash -c 'source scripts/common.sh' 2>&1` -- must output "[ERROR] Bash 4.0+ required (found: 3.2.57..." and exit non-zero.
    Run: `bash -c 'source scripts/common.sh && echo "OK"'` -- must output "OK" (modern bash from Homebrew).
    Run: `bash scripts/nmap/examples.sh 2>&1 | head -5` -- must NOT show a version error (modern bash runs the script fine, it will fail for missing target but that's expected).
  </verify>
  <done>common.sh has a version guard that produces a clear "[ERROR] Bash 4.0+ required" message with macOS install hint on Bash 3.x, and passes through silently on Bash 4.0+.</done>
</task>

<task type="auto">
  <name>Task 3: Create .shellcheckrc for source path resolution (NORM-03)</name>
  <files>.shellcheckrc</files>
  <action>
    Create `.shellcheckrc` at the project root (/Users/patrykattc/work/git/networking-tools/.shellcheckrc) with:

    ```
    # .shellcheckrc -- ShellCheck project-level configuration
    # ShellCheck walks up from each script's directory to find this file

    # Resolve source statements relative to each script's directory
    source-path=SCRIPTDIR
    source-path=SCRIPTDIR/..

    # Future-proofing for Phase 13 library split (common.sh will source lib/*.sh)
    source-path=SCRIPTDIR/../lib

    # Allow following dynamically-constructed source paths
    external-sources=true
    ```

    Place this file at the project root ONLY. Do NOT create any subdirectory-level .shellcheckrc files.

    Three source-path entries:
    - `SCRIPTDIR`: For check-tools.sh which sources common.sh from the same directory
    - `SCRIPTDIR/..`: For scripts/<tool>/examples.sh which source ../common.sh (resolves to scripts/)
    - `SCRIPTDIR/../lib`: Pre-positioned for Phase 13 library split

    After creating the file, install shellcheck if not already installed (`brew install shellcheck`) and verify SC1091 is resolved.
  </action>
  <verify>
    Run: `cat .shellcheckrc` -- must show the 4 directives (3 source-path + external-sources).
    Run: `shellcheck scripts/nmap/examples.sh 2>&1 | grep -c 'SC1091'` -- must return 0 (no "not following" warnings). Install shellcheck first if needed.
    Run: `shellcheck scripts/check-tools.sh 2>&1 | grep -c 'SC1091'` -- must return 0 (handles same-directory source pattern).
    Run: `shellcheck scripts/nmap/identify-ports.sh 2>&1 | grep -c 'SC1091'` -- must return 0 (handles use-case script source pattern).
  </verify>
  <done>.shellcheckrc exists at project root with source-path and external-sources directives. ShellCheck resolves all source statements without SC1091 warnings for scripts in any subdirectory.</done>
</task>

</tasks>

<verification>
Run all three requirement verification commands:

1. NORM-01: `grep -rn '\[\[ -t 0 \]\] || exit 0' scripts/` returns zero results AND `grep -rn '\[\[ ! -t 0 \]\] && exit 0' scripts/ | wc -l` returns 63.
2. NORM-02: `/bin/bash -c 'source scripts/common.sh' 2>&1` prints clear "[ERROR] Bash 4.0+ required" message.
3. NORM-03: `shellcheck scripts/nmap/examples.sh 2>&1 | grep -c 'SC1091'` returns 0.
</verification>

<success_criteria>
- Zero instances of `[[ -t 0 ]] || exit 0` remain in scripts/
- Exactly 63 instances of `[[ ! -t 0 ]] && exit 0` exist in scripts/
- macOS system bash (/bin/bash 3.2) produces a clear error when sourcing common.sh
- Modern bash (4.0+) sources common.sh without error
- ShellCheck resolves source paths for scripts in any subdirectory without SC1091 warnings
- No guards added to or removed from scripts that should not have them (5 scripts)
</success_criteria>

<output>
After completion, create `.planning/phases/12-pre-refactor-cleanup/12-01-SUMMARY.md`
</output>
