---
phase: 19-library-unit-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/lib-logging.bats
  - tests/lib-cleanup.bats
autonomous: true

must_haves:
  truths:
    - "info() outputs message containing [INFO] when LOG_LEVEL is info or debug"
    - "info() is suppressed when LOG_LEVEL is warn or error"
    - "warn() outputs message containing [WARN]"
    - "error() writes to stderr, not stdout"
    - "debug() outputs only when LOG_LEVEL is debug"
    - "debug() is suppressed when LOG_LEVEL is info"
    - "success() outputs message containing [OK]"
    - "NO_COLOR=1 suppresses ANSI escape codes in log output"
    - "make_temp file creates a regular file"
    - "make_temp dir creates a directory"
    - "EXIT trap cleans up temp files when process exits"
  artifacts:
    - path: "tests/lib-logging.bats"
      provides: "UNIT-03 logging function tests"
      contains: "@test"
    - path: "tests/lib-cleanup.bats"
      provides: "UNIT-04 make_temp and EXIT trap tests"
      contains: "@test"
  key_links:
    - from: "tests/lib-logging.bats"
      to: "scripts/lib/logging.sh"
      via: "source common.sh in setup()"
      pattern: "source.*common\\.sh"
    - from: "tests/lib-cleanup.bats"
      to: "scripts/lib/cleanup.sh"
      via: "source common.sh in setup()"
      pattern: "source.*common\\.sh"
---

<objective>
Create BATS unit tests for logging functions (logging.sh) and temp file cleanup (cleanup.sh).

Purpose: Prove logging functions respect LOG_LEVEL filtering and NO_COLOR (UNIT-03), and make_temp creates files/dirs with EXIT trap cleanup (UNIT-04).
Output: tests/lib-logging.bats (~12 tests) and tests/lib-cleanup.bats (~6 tests)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-library-unit-tests/19-RESEARCH.md
@.planning/phases/18-bats-infrastructure/18-01-SUMMARY.md
@tests/smoke.bats
@tests/test_helper/common-setup.bash
@scripts/lib/logging.sh
@scripts/lib/cleanup.sh
@scripts/lib/colors.sh
@scripts/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib-logging.bats with logging and LOG_LEVEL tests (UNIT-03)</name>
  <files>tests/lib-logging.bats</files>
  <action>
Create `tests/lib-logging.bats` following the established pattern.

setup() must:
1. `load 'test_helper/common-setup'` and call `_common_setup`
2. Define `show_help() { echo "test help"; }`
3. `source "${PROJECT_ROOT}/scripts/common.sh"`
4. `set +eEuo pipefail` and `trap - ERR`
5. Reset: `VERBOSE=0`, `LOG_LEVEL="info"`

IMPORTANT context on how logging functions work:
- `info()`, `success()`, `warn()` write to stdout via `echo -e`
- `error()` writes to stderr via `echo -e ... >&2`
- `debug()` writes to stdout but only when `_should_log debug` is true (requires LOG_LEVEL=debug)
- `_should_log` compares numeric log levels: debug=0, info=1, warn=2, error=3
- `info` and `success` are gated at info level (suppressed when LOG_LEVEL=warn or error)
- `warn` is gated at warn level (suppressed when LOG_LEVEL=error)
- `error()` is NOT gated -- always writes
- NO_COLOR=1 is already set by `_common_setup`, so all color variables (RED, GREEN, etc.) are empty strings. Output will NOT contain ANSI escape sequences.
- When VERBOSE >= 1, logging functions prepend a timestamp `[HH:MM:SS]`

Write these tests (~12 total):

**info() tests:**
1. `info outputs message with INFO tag`: `run info "test message"`, assert_success, assert_output --partial "[INFO]", assert_output --partial "test message"
2. `info is suppressed when LOG_LEVEL is warn`: set `LOG_LEVEL="warn"`, `run info "test message"`, assert_success, refute_output (empty output since suppressed)
3. `info is suppressed when LOG_LEVEL is error`: set `LOG_LEVEL="error"`, `run info "test message"`, assert_success, refute_output

**success() tests:**
4. `success outputs message with OK tag`: `run success "done"`, assert_success, assert_output --partial "[OK]"

**warn() tests:**
5. `warn outputs message with WARN tag`: `run warn "caution"`, assert_success, assert_output --partial "[WARN]"
6. `warn is suppressed when LOG_LEVEL is error`: set `LOG_LEVEL="error"`, `run warn "caution"`, assert_success, refute_output

**error() tests:**
7. `error writes to stderr not stdout`: `run --separate-stderr error "something broke"`, assert_success, refute_output (stdout empty). Then check stderr: `assert [ -n "$stderr" ]` and `[[ "$stderr" == *"[ERROR]"* ]]` (or try `assert_stderr --partial "[ERROR]"` if available in bats-assert v2.2.0 -- fall back to manual check if not)
8. `error is never suppressed regardless of LOG_LEVEL`: set `LOG_LEVEL="error"`, `run --separate-stderr error "still visible"`, assert [ -n "$stderr" ]

**debug() tests:**
9. `debug outputs when LOG_LEVEL is debug`: set `LOG_LEVEL="debug"`, `run debug "trace info"`, assert_success, assert_output --partial "[DEBUG]"
10. `debug is suppressed when LOG_LEVEL is info`: (LOG_LEVEL is already "info" from setup), `run debug "trace info"`, assert_success, refute_output

**NO_COLOR tests:**
11. `log output contains no ANSI escape codes with NO_COLOR`: (NO_COLOR=1 is already set by _common_setup, so color vars are empty), `run info "color test"`, assert_success, `refute_output --regexp '\x1b\['` (refute that output contains ESC[). If `\x1b` does not work in the regexp, use `refute_output --regexp $'\033'` or check manually: `[[ "$output" != *$'\033'* ]]`

**VERBOSE timestamp test:**
12. `info includes timestamp when VERBOSE >= 1`: set `VERBOSE=1`, `run info "timed message"`, assert_success, assert_output --regexp '\[([0-9]{2}:){2}[0-9]{2}\]' (matches [HH:MM:SS])

Do NOT modify smoke.bats or common-setup.bash.
  </action>
  <verify>Run `./tests/bats/bin/bats tests/lib-logging.bats` -- all tests pass. Confirm no ANSI codes appear in assertion failures (NO_COLOR working).</verify>
  <done>12 tests in lib-logging.bats pass, covering info/success/warn/error/debug output, LOG_LEVEL filtering for info/warn/debug, NO_COLOR suppression, and VERBOSE timestamps.</done>
</task>

<task type="auto">
  <name>Task 2: Create lib-cleanup.bats with make_temp and EXIT trap tests (UNIT-04)</name>
  <files>tests/lib-cleanup.bats</files>
  <action>
Create `tests/lib-cleanup.bats` following the established pattern.

setup() must:
1. `load 'test_helper/common-setup'` and call `_common_setup`
2. Define `show_help() { echo "test help"; }`
3. `source "${PROJECT_ROOT}/scripts/common.sh"`
4. `set +eEuo pipefail` and `trap - ERR`

IMPORTANT context on how cleanup.sh works:
- When cleanup.sh is sourced (via common.sh), it immediately creates `$_CLEANUP_BASE_DIR` (a temp directory) and registers an EXIT trap (`_cleanup_handler`)
- `make_temp file` creates a temp file inside `$_CLEANUP_BASE_DIR` and echoes its path
- `make_temp dir` creates a temp directory inside `$_CLEANUP_BASE_DIR` and echoes its path
- The EXIT trap removes `$_CLEANUP_BASE_DIR` recursively and runs `_CLEANUP_COMMANDS`
- `register_cleanup` appends a command string to `_CLEANUP_COMMANDS` array
- Inside BATS @test subshells, the EXIT trap fires when the test subshell ends (AFTER the test body), so temp files created by make_temp STILL EXIST during the test body
- To test cleanup behavior, use `bash -c` subprocess that sources common.sh, creates a temp file, exits, and then check from the parent that the file is gone

Write these tests (~6 total):

1. `make_temp creates a regular file`: call `local tmpfile; tmpfile=$(make_temp file)`, then `assert_file_exists "$tmpfile"`
2. `make_temp creates a directory when type is dir`: call `local tmpdir; tmpdir=$(make_temp dir)`, then `assert_dir_exists "$tmpdir"`
3. `make_temp with custom prefix uses prefix in filename`: call `local tmpfile; tmpfile=$(make_temp file "myprefix")`, then `[[ "$(basename "$tmpfile")" == myprefix.* ]]`
4. `make_temp default type is file`: call `local tmpfile; tmpfile=$(make_temp)`, then `assert_file_exists "$tmpfile"`, `[[ -f "$tmpfile" ]]` (confirm it is a file, not a directory)
5. `EXIT trap cleans up temp files when process exits`: run a subprocess:
    ```
    local tmpfile
    tmpfile=$(bash -c "
        source '${PROJECT_ROOT}/scripts/common.sh'
        set +eEuo pipefail
        trap - ERR
        make_temp file
    ")
    assert_file_not_exists "$tmpfile"
    ```
    The subprocess exits, its EXIT trap fires, and the file is removed. The parent shell then asserts the file is gone.

6. `EXIT trap cleans up temp directories when process exits`: same pattern as test 5 but with `make_temp dir`:
    ```
    local tmpdir
    tmpdir=$(bash -c "
        source '${PROJECT_ROOT}/scripts/common.sh'
        set +eEuo pipefail
        trap - ERR
        make_temp dir
    ")
    assert_dir_not_exists "$tmpdir"
    ```

NOTE: For tests 5 and 6, `bash -c` creates a fresh subprocess. The subprocess sources common.sh (which creates its OWN `$_CLEANUP_BASE_DIR`), calls make_temp, echoes the path to stdout, then exits (firing its EXIT trap which removes its `$_CLEANUP_BASE_DIR`). The parent captures the path and checks it no longer exists.

Do NOT modify smoke.bats or common-setup.bash.
  </action>
  <verify>Run `./tests/bats/bin/bats tests/lib-cleanup.bats` -- all tests pass. Then `make test` confirms all tests (smoke + any other lib-* tests) pass together.</verify>
  <done>6 tests in lib-cleanup.bats pass, covering make_temp file/dir creation, custom prefix, default type, and EXIT trap cleanup for both files and directories.</done>
</task>

</tasks>

<verification>
Run `make test` from project root. All tests pass:
- 5 existing smoke tests
- 12 lib-logging tests (UNIT-03)
- 6 lib-cleanup tests (UNIT-04)
Plus any other lib-* tests from parallel plans.
</verification>

<success_criteria>
- lib-logging.bats exists with ~12 tests covering info/success/warn/error/debug, LOG_LEVEL filtering, NO_COLOR, and VERBOSE timestamps
- lib-cleanup.bats exists with ~6 tests covering make_temp file/dir creation and EXIT trap cleanup
- `make test` exits 0 with all tests passing
- No modifications to smoke.bats or common-setup.bash
</success_criteria>

<output>
After completion, create `.planning/phases/19-library-unit-tests/19-02-SUMMARY.md`
</output>
