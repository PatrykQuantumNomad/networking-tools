---
phase: 19-library-unit-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/lib-args.bats
  - tests/lib-validation.bats
autonomous: true

must_haves:
  truths:
    - "parse_common_args -v sets VERBOSE >= 1 and LOG_LEVEL to debug"
    - "parse_common_args -q sets LOG_LEVEL to warn"
    - "parse_common_args -x sets EXECUTE_MODE to execute"
    - "parse_common_args -h calls show_help and exits 0"
    - "parse_common_args -- stops flag parsing and passes remainder to REMAINING_ARGS"
    - "Unknown flags and positional args land in REMAINING_ARGS"
    - "Combined flags (-v -x) set both VERBOSE and EXECUTE_MODE"
    - "require_cmd succeeds for present commands and exits 1 for missing commands"
    - "require_cmd shows install hint when provided"
    - "check_cmd returns 0 for present commands and 1 for missing commands"
    - "require_target exits 1 when no argument is provided"
  artifacts:
    - path: "tests/lib-args.bats"
      provides: "UNIT-01 parse_common_args tests"
      contains: "@test"
    - path: "tests/lib-validation.bats"
      provides: "UNIT-02 require_cmd, check_cmd, require_target tests"
      contains: "@test"
  key_links:
    - from: "tests/lib-args.bats"
      to: "scripts/lib/args.sh"
      via: "source common.sh in setup()"
      pattern: "source.*common\\.sh"
    - from: "tests/lib-validation.bats"
      to: "scripts/lib/validation.sh"
      via: "source common.sh in setup()"
      pattern: "source.*common\\.sh"
---

<objective>
Create BATS unit tests for argument parsing (args.sh) and command validation (validation.sh) libraries.

Purpose: Prove parse_common_args handles all flag combinations correctly (UNIT-01) and require_cmd/check_cmd/require_target validate commands and targets correctly (UNIT-02).
Output: tests/lib-args.bats (~10 tests) and tests/lib-validation.bats (~8 tests)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-library-unit-tests/19-RESEARCH.md
@.planning/phases/18-bats-infrastructure/18-01-SUMMARY.md
@tests/smoke.bats
@tests/test_helper/common-setup.bash
@scripts/lib/args.sh
@scripts/lib/validation.sh
@scripts/common.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib-args.bats with parse_common_args tests (UNIT-01)</name>
  <files>tests/lib-args.bats</files>
  <action>
Create `tests/lib-args.bats` following the established pattern from smoke.bats.

setup() must:
1. `load 'test_helper/common-setup'` and call `_common_setup`
2. Define `show_help() { echo "test help output"; }` (required by -h handler)
3. `source "${PROJECT_ROOT}/scripts/common.sh"`
4. `set +eEuo pipefail` and `trap - ERR` (disable strict mode for BATS)
5. Reset mutable state: `VERBOSE=0`, `LOG_LEVEL="info"`, `EXECUTE_MODE="show"`, `REMAINING_ARGS=()`

Write these tests (~10 total):

1. `-v` sets VERBOSE >= 1: call `parse_common_args -v target`, assert `(( VERBOSE >= 1 ))`
2. `-v` sets LOG_LEVEL to debug: call `parse_common_args -v target`, assert `assert_equal "$LOG_LEVEL" "debug"`
3. `--verbose` long flag works same as `-v`: call `parse_common_args --verbose target`, assert VERBOSE >= 1
4. `-q` sets LOG_LEVEL to warn: call `parse_common_args -q target`, assert `assert_equal "$LOG_LEVEL" "warn"`
5. `-x` sets EXECUTE_MODE to execute: call `parse_common_args -x target`, assert `assert_equal "$EXECUTE_MODE" "execute"`
6. `--execute` long flag works same as `-x`: call `parse_common_args --execute target`, assert EXECUTE_MODE equals "execute"
7. `-h` calls show_help and exits 0: use `run parse_common_args -h`, assert_success, assert_output "test help output"
8. `--` stops flag parsing: call `parse_common_args -- -v -x target`, assert EXECUTE_MODE is "show", VERBOSE is 0, REMAINING_ARGS is "-v -x target"
9. Unknown flags pass to REMAINING_ARGS: call `parse_common_args --custom target`, assert `REMAINING_ARGS` is "--custom target"
10. Combined flags (-v -x) set both: call `parse_common_args -v -x target`, assert VERBOSE >= 1, EXECUTE_MODE is "execute", REMAINING_ARGS is "target"
11. No args produces empty REMAINING_ARGS: call `parse_common_args`, assert `${#REMAINING_ARGS[@]}` is 0
12. Flags after positional args still work: call `parse_common_args target -x`, assert EXECUTE_MODE is "execute", REMAINING_ARGS is "target"

Use `assert_equal` for string comparisons. Use `(( VERBOSE >= 1 ))` for numeric checks. Use `run` ONLY for `-h` test (which calls exit). All other tests call `parse_common_args` directly since they do not exit.

Do NOT modify smoke.bats or common-setup.bash.
  </action>
  <verify>Run `make test` -- all existing smoke tests plus new lib-args tests pass. Specifically: `./tests/bats/bin/bats tests/lib-args.bats` shows all tests passing.</verify>
  <done>12 tests in lib-args.bats pass, covering -v, --verbose, -q, -x, --execute, -h, --, unknown flags, combined flags, no args, and flag ordering.</done>
</task>

<task type="auto">
  <name>Task 2: Create lib-validation.bats with require_cmd, check_cmd, require_target tests (UNIT-02)</name>
  <files>tests/lib-validation.bats</files>
  <action>
Create `tests/lib-validation.bats` following the same setup pattern as Task 1.

setup() must:
1. `load 'test_helper/common-setup'` and call `_common_setup`
2. Define `show_help() { echo "test help"; }` (needed by common.sh sourcing)
3. `source "${PROJECT_ROOT}/scripts/common.sh"`
4. `set +eEuo pipefail` and `trap - ERR`

Write these tests (~8 total):

1. `check_cmd` returns 0 for present command: `check_cmd bash` then assert `$?` is 0 (or just call it -- success means it returned 0)
2. `check_cmd` returns 1 for missing command: `run check_cmd "nonexistent_command_xyz_123"`, assert_failure
3. `require_cmd` succeeds for present command: `run require_cmd bash`, assert_success
4. `require_cmd` exits 1 for missing command: `run require_cmd "nonexistent_command_xyz_123"`, assert_failure
5. `require_cmd` shows install hint: `run require_cmd "nonexistent_command_xyz_123" "brew install xyz"`, assert_failure, assert_output --partial "Install: brew install xyz"
6. `require_cmd` error message includes command name: `run require_cmd "nonexistent_command_xyz_123"`, assert_output --partial "nonexistent_command_xyz_123"  (note: error() writes to stderr, but `run` without --separate-stderr combines both streams -- verify this works; if not, use `run --separate-stderr` and check `$stderr`)
7. `require_target` exits 1 when no argument provided: `run require_target`, assert_failure
8. `require_target` succeeds when argument provided: `run require_target "192.168.1.1"`, assert_success

IMPORTANT for tests 4-6: `require_cmd` calls `error()` which writes to stderr, and `info()` which writes to stdout. By default, `run` only captures stdout. Use `run --separate-stderr` when you need to assert on error messages. For test 5 (install hint), the hint is output via `info` (stdout), so `assert_output --partial` will work. For test 6 (error message with command name), the error message goes to stderr, so use `run --separate-stderr` and check `$stderr` with `[[ "$stderr" == *"nonexistent_command_xyz_123"* ]]`.

For `check_cmd` test 1 (success case): call `check_cmd bash` directly (no `run`), relying on the fact that setup disabled strict mode so a successful return 0 just continues.

For `check_cmd` test 2 (failure case): use `run check_cmd "nonexistent_command_xyz_123"` because the function returns 1 which would be fine with strict mode off, but `run` gives clean assertion syntax.

Do NOT modify smoke.bats or common-setup.bash.
  </action>
  <verify>Run `./tests/bats/bin/bats tests/lib-validation.bats` -- all tests pass. Then run `make test` to confirm all tests (smoke + lib-args + lib-validation) pass together.</verify>
  <done>8 tests in lib-validation.bats pass, covering check_cmd success/failure, require_cmd success/failure/install-hint/error-message, and require_target empty/provided.</done>
</task>

</tasks>

<verification>
Run `make test` from project root. All tests pass:
- 5 existing smoke tests
- 12 lib-args tests (UNIT-01)
- 8 lib-validation tests (UNIT-02)
Total: 25 tests, 0 failures.
</verification>

<success_criteria>
- lib-args.bats exists with ~12 tests covering all parse_common_args flag combinations
- lib-validation.bats exists with ~8 tests covering check_cmd, require_cmd, require_target
- `make test` exits 0 with all tests passing
- No modifications to smoke.bats or common-setup.bash
</success_criteria>

<output>
After completion, create `.planning/phases/19-library-unit-tests/19-01-SUMMARY.md`
</output>
