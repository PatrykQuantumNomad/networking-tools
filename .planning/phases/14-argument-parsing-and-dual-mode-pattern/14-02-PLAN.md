---
phase: 14-argument-parsing-and-dual-mode-pattern
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/test-arg-parsing.sh
autonomous: true

must_haves:
  truths:
    - "scripts/nmap/examples.sh --help prints usage information; -h does the same"
    - "scripts/nmap/examples.sh scanme.nmap.org shows educational examples with no behavioral change from pre-migration"
    - "scripts/nmap/examples.sh -x scanme.nmap.org prompts for confirmation then would execute commands"
    - "make nmap TARGET=scanme.nmap.org still works identically"
    - "Unknown flags like --custom-thing pass through without error"
  artifacts:
    - path: "tests/test-arg-parsing.sh"
      provides: "Automated verification of all 5 phase success criteria"
      contains: "parse_common_args"
  key_links:
    - from: "tests/test-arg-parsing.sh"
      to: "scripts/nmap/examples.sh"
      via: "runs pilot script with various flag combinations"
      pattern: "nmap/examples.sh"
    - from: "tests/test-arg-parsing.sh"
      to: "scripts/lib/args.sh"
      via: "sources common.sh and tests parse_common_args directly"
      pattern: "parse_common_args"
---

<objective>
Verify all 5 phase success criteria against the pilot-migrated nmap/examples.sh with an automated test script.

Purpose: Prove the arg parser and dual-mode pattern work correctly before mass-migrating 65 more scripts in Phases 15-16. Catch any edge cases in flag ordering, backward compatibility, or output fidelity.
Output: test-arg-parsing.sh that validates every success criterion.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/14-argument-parsing-and-dual-mode-pattern/14-RESEARCH.md
@.planning/phases/14-argument-parsing-and-dual-mode-pattern/14-01-SUMMARY.md

@scripts/lib/args.sh
@scripts/lib/output.sh
@scripts/nmap/examples.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test script verifying all 5 success criteria</name>
  <files>tests/test-arg-parsing.sh</files>
  <action>
Create `tests/test-arg-parsing.sh` as an executable bash script that validates all 5 phase success criteria. Follow the same smoke-test pattern established in `tests/test-library-loads.sh` (from Phase 13-02): use pass/fail counters and colored output.

**Test structure:**

```bash
#!/usr/bin/env bash
# test-arg-parsing.sh -- Verify Phase 14 argument parsing and dual-mode pattern
```

Source common.sh for test helpers (info, success, warn, error, etc.).

**SC1: --help and -h print usage**
- Run `bash scripts/nmap/examples.sh --help 2>&1` and check output contains "Usage:"
- Run `bash scripts/nmap/examples.sh -h 2>&1` and check output contains "Usage:"
- Both should exit 0

**SC2: Backward-compatible default mode**
- Run `bash scripts/nmap/examples.sh scanme.nmap.org 2>/dev/null` and capture stdout
- Check output contains "1) Ping scan" (first example)
- Check output contains "10) Save results" (last example)
- Check output contains "nmap -sn scanme.nmap.org" (command with target expanded)
- Check output contains "nmap -sn 192.168.1.0/24" (static example 9, unchanged)

**SC3: -x mode requires interactive confirmation**
- Run `echo "" | bash scripts/nmap/examples.sh -x scanme.nmap.org 2>&1` (piped, non-interactive)
- Check stderr contains "interactive terminal" warning
- Check exit code is non-zero (1)

**SC4: make nmap TARGET=... works**
- Run `make nmap TARGET=scanme.nmap.org 2>/dev/null` and capture stdout
- Check output contains "1) Ping scan" (same as SC2 -- Makefile passes TARGET as $1)
- Note: This test depends on the Makefile being present. If make is not available, skip with a warning.

**SC5: Unknown flags pass through**
- Run `bash scripts/nmap/examples.sh --custom-thing scanme.nmap.org 2>/dev/null` and capture stdout
- Check it produces output (not an error exit)
- Check exit code is 0
- Also test flag-order independence: `bash scripts/nmap/examples.sh scanme.nmap.org --custom-thing 2>/dev/null`

**Unit tests for parse_common_args directly:**
- Source common.sh, define a minimal `show_help() { echo "help"; }`, then:
  - Test: `parse_common_args -v scanme.nmap.org` -> VERBOSE >= 1, LOG_LEVEL=debug, REMAINING_ARGS=(scanme.nmap.org)
  - Test: `parse_common_args -q scanme.nmap.org` -> LOG_LEVEL=warn, REMAINING_ARGS=(scanme.nmap.org)
  - Test: `parse_common_args -x scanme.nmap.org` -> EXECUTE_MODE=execute, REMAINING_ARGS=(scanme.nmap.org)
  - Test: `parse_common_args --custom-flag scanme.nmap.org` -> REMAINING_ARGS=(--custom-flag scanme.nmap.org)
  - Test: `parse_common_args scanme.nmap.org -x` -> EXECUTE_MODE=execute, REMAINING_ARGS=(scanme.nmap.org) (flag after positional)
  - Test: `parse_common_args -- -x scanme.nmap.org` -> EXECUTE_MODE=show (unchanged), REMAINING_ARGS=(-x scanme.nmap.org) (-- stops parsing)

**Empty args safety:**
- Test: `parse_common_args` (no args) -> REMAINING_ARGS is empty, no error under set -u
- Test: After empty parse, `set -- "${REMAINING_ARGS[@]+${REMAINING_ARGS[@]}}"` succeeds without error

Print summary at end: N passed, M failed. Exit 1 if any failures.
  </action>
  <verify>
Run the test:
```bash
bash tests/test-arg-parsing.sh
```
Expected: all tests pass, exit code 0.

Verify the test itself is valid (not false-passing):
```bash
bash tests/test-arg-parsing.sh && echo "EXIT: $?" || echo "EXIT: $?"
```
Expected: EXIT: 0
  </verify>
  <done>
- tests/test-arg-parsing.sh exists and is executable
- All 5 phase success criteria verified by automated tests
- Unit tests confirm parse_common_args handles all flag combinations correctly
- Edge cases tested: empty args, flag ordering, -- separator, unknown flags
- Test exits 0 when all pass, exits 1 on any failure
  </done>
</task>

</tasks>

<verification>
Run the full test suite:
```bash
bash tests/test-arg-parsing.sh
```
All tests must pass. The 5 success criteria from the ROADMAP are the acceptance gate:
1. --help/-h prints usage
2. Default mode is backward compatible
3. -x mode prompts for confirmation
4. make nmap TARGET=... works
5. Unknown flags pass through
</verification>

<success_criteria>
- All 5 phase success criteria pass automated verification
- parse_common_args unit tests cover: -v, -q, -x, -h, --, unknown flags, flag ordering, empty args
- Test script follows established test pattern from Phase 13 (pass/fail counters, colored output)
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/14-argument-parsing-and-dual-mode-pattern/14-02-SUMMARY.md`
</output>
