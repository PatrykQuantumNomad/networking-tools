---
phase: 15-examples-script-migration
plan: 04
type: execute
wave: 2
depends_on: [15-01, 15-02, 15-03]
files_modified:
  - tests/test-arg-parsing.sh
autonomous: true

must_haves:
  truths:
    - "All 17 examples.sh scripts pass --help test (exits 0, prints Usage)"
    - "All 17 examples.sh scripts pass -x non-interactive rejection test"
    - "All 12 make targets produce output (backward compatibility verified)"
    - "Test suite reports 0 failures"
  artifacts:
    - path: "tests/test-arg-parsing.sh"
      provides: "Comprehensive test coverage for all 17 scripts"
      contains: "for tool_dir in"
  key_links:
    - from: "tests/test-arg-parsing.sh"
      to: "scripts/*/examples.sh"
      via: "test loop iterating all tool directories"
      pattern: "for tool_dir in"
---

<objective>
Extend the Phase 14 test suite to verify all 17 migrated examples.sh scripts and run full regression.

Purpose: The existing test suite only covers nmap (the Phase 14 pilot). Phase 15 needs verification across all 17 scripts to confirm backward compatibility and flag consistency.
Output: Updated test-arg-parsing.sh covering all 17 scripts with passing regression.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-examples-script-migration/15-RESEARCH.md
@.planning/phases/14-argument-parsing-and-dual-mode-pattern/14-02-SUMMARY.md
@tests/test-arg-parsing.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend test suite to cover all 17 examples.sh scripts</name>
  <files>
    tests/test-arg-parsing.sh
  </files>
  <action>
Extend tests/test-arg-parsing.sh to validate all 17 scripts. Keep the existing nmap-specific tests (SC1-SC5 and unit tests) intact. Add a new section after them that loops over all 17 scripts.

**New test section: All-scripts loop**

Add the following test categories in a loop over all `scripts/*/examples.sh`:

1. **--help exits 0 for all scripts** (works without tool installed since parse_common_args handles -h before require_cmd):
   ```bash
   for tool_dir in "${PROJECT_ROOT}/scripts"/*/; do
       script="${tool_dir}examples.sh"
       [[ -f "$script" ]] || continue
       tool=$(basename "$tool_dir")

       if bash "$script" --help &>/dev/null; then
           check_pass "${tool}: --help exits 0"
       else
           check_fail "${tool}: --help exits non-zero"
       fi
   done
   ```

2. **-x rejects non-interactive stdin for all scripts.** For target-required scripts, pass a dummy target. For no-target scripts, pass no target. Use an associative array to map tools to their test targets:
   ```bash
   declare -A TOOL_TARGETS=(
       [nmap]="scanme.nmap.org"
       [dig]="example.com"
       [curl]="example.com"
       [hping3]="example.com"
       [gobuster]="http://example.com"
       [ffuf]="http://example.com"
       [nikto]="http://example.com"
       [sqlmap]="http://example.com"
       [skipfish]="http://example.com"
       [traceroute]="example.com"
       [netcat]="127.0.0.1"
       [foremost]=""
       [tshark]=""
       [metasploit]=""
       [hashcat]=""
       [john]=""
       [aircrack-ng]=""
   )

   for tool_dir in "${PROJECT_ROOT}/scripts"/*/; do
       script="${tool_dir}examples.sh"
       [[ -f "$script" ]] || continue
       tool=$(basename "$tool_dir")
       target="${TOOL_TARGETS[$tool]:-}"

       exec_output=$(echo "" | bash "$script" -x $target 2>&1)
       exec_exit=$?
       if [[ $exec_exit -ne 0 ]]; then
           check_pass "${tool}: -x rejects non-interactive ($exec_exit)"
       else
           check_fail "${tool}: -x does not reject non-interactive"
       fi
   done
   ```

3. **Makefile backward compatibility** for the 12 targets that have make rules. Test that `make <tool> TARGET=<value>` exits 0 and produces output containing at least one numbered example line:
   ```bash
   declare -A MAKE_TARGETS=(
       [nmap]="scanme.nmap.org"
       [tshark]=""
       [sqlmap]="http://example.com"
       [nikto]="http://example.com"
       [hping3]="example.com"
       [foremost]=""
       [dig]="example.com"
       [curl]="example.com"
       [netcat]="127.0.0.1"
       [traceroute]="example.com"
       [gobuster]="http://example.com"
       [ffuf]="http://example.com"
   )
   ```
   For each make target: run `make -C "${PROJECT_ROOT}" <tool> TARGET=<value>` (omit TARGET= for empty values), check exit 0, check output contains "1)" (first example marker).

**Important notes:**
- Keep the existing nmap-specific SC1-SC5 and unit test sections unchanged (they are more detailed and serve as the pilot validation).
- The new all-scripts loop goes AFTER the existing tests, in new clearly labeled sections.
- The `$target` variable in the -x test must NOT be quoted (so empty targets expand to nothing, not an empty string argument): use `$target` not `"$target"`.
- Handle tools not installed gracefully: --help works before require_cmd, but the -x test might fail if the tool is not installed (require_cmd exits before confirm_execute). For the -x test, check that the script exits non-zero (which it will, either from require_cmd or confirm_execute) -- both are acceptable failures.
  </action>
  <verify>
Run the test suite:
```bash
bash tests/test-arg-parsing.sh
```
Expected: All tests pass (0 failures). Report total pass count (should be significantly higher than the original 30).
  </verify>
  <done>
Test suite covers all 17 examples.sh scripts for --help, -x rejection, and Makefile backward compatibility. All tests pass with 0 failures.
  </done>
</task>

</tasks>

<verification>
1. `bash tests/test-arg-parsing.sh` exits 0 with 0 failures
2. Test output shows all 17 tool names in --help tests
3. Test output shows all 17 tool names in -x rejection tests
4. Test output shows all 12 make targets tested
5. Original nmap-specific tests (SC1-SC5, unit tests) still present and passing
</verification>

<success_criteria>
Comprehensive test suite validates all 4 phase success criteria across all 17 scripts. Zero failures confirms the migration is complete and backward-compatible.
</success_criteria>

<output>
After completion, create `.planning/phases/15-examples-script-migration/15-04-SUMMARY.md`
</output>
