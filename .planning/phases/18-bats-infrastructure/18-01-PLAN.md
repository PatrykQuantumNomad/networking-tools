---
phase: 18-bats-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .gitmodules
  - tests/bats (submodule)
  - tests/test_helper/bats-support (submodule)
  - tests/test_helper/bats-assert (submodule)
  - tests/test_helper/bats-file (submodule)
  - tests/test_helper/common-setup.bash
  - tests/smoke.bats
  - Makefile
  - .github/workflows/shellcheck.yml
autonomous: true

must_haves:
  truths:
    - "`make test` runs BATS test suite and exits 0 with TAP output"
    - "`make test-verbose` shows per-test results with timing"
    - "Smoke test sources common.sh and asserts library function behavior without strict mode or trap conflicts crashing BATS"
    - "bats-assert and bats-file assertions work in test files via shared helper"
  artifacts:
    - path: ".gitmodules"
      provides: "BATS submodule declarations"
      contains: "tests/bats"
    - path: "tests/test_helper/common-setup.bash"
      provides: "Shared test helper with dual-path library loading"
      contains: "_common_setup"
    - path: "tests/smoke.bats"
      provides: "Smoke test proving infrastructure works"
      contains: "@test"
    - path: "Makefile"
      provides: "test and test-verbose targets"
      contains: "tests/bats/bin/bats"
  key_links:
    - from: "tests/smoke.bats"
      to: "tests/test_helper/common-setup.bash"
      via: "load 'test_helper/common-setup'"
      pattern: "load.*test_helper/common-setup"
    - from: "tests/test_helper/common-setup.bash"
      to: "tests/test_helper/bats-assert"
      via: "load or bats_load_library"
      pattern: "bats-assert"
    - from: "Makefile"
      to: "tests/bats/bin/bats"
      via: "test target recipe"
      pattern: "tests/bats/bin/bats"
---

<objective>
Install BATS-core test framework via git submodules, create the shared test helper, add Makefile targets, and prove everything works with a smoke test.

Purpose: Establish the test infrastructure foundation that all subsequent testing phases (19-21) depend on. The smoke test proves strict mode and trap conflicts are resolved before writing real tests.
Output: Working `make test` and `make test-verbose` commands, shared test helper, and a passing smoke test with 5 assertions.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-bats-infrastructure/18-RESEARCH.md
@Makefile
@.github/workflows/shellcheck.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install BATS submodules, create shared test helper, add Makefile targets, update ShellCheck exclusions</name>
  <files>
    .gitmodules
    tests/bats (submodule)
    tests/test_helper/bats-support (submodule)
    tests/test_helper/bats-assert (submodule)
    tests/test_helper/bats-file (submodule)
    tests/test_helper/common-setup.bash
    Makefile
    .github/workflows/shellcheck.yml
  </files>
  <action>
**Step 1: Add git submodules (INFRA-01)**

Run these commands from the project root:

```bash
git submodule add https://github.com/bats-core/bats-core.git tests/bats
git submodule add https://github.com/bats-core/bats-support.git tests/test_helper/bats-support
git submodule add https://github.com/bats-core/bats-assert.git tests/test_helper/bats-assert
git submodule add https://github.com/bats-core/bats-file.git tests/test_helper/bats-file
```

Then pin to exact versions:

```bash
cd tests/bats && git checkout v1.13.0 && cd ../..
cd tests/test_helper/bats-support && git checkout v0.3.0 && cd ../../..
cd tests/test_helper/bats-assert && git checkout v2.2.0 && cd ../../..
cd tests/test_helper/bats-file && git checkout v0.4.0 && cd ../../..
```

Stage the pinned versions: `git add tests/bats tests/test_helper/bats-support tests/test_helper/bats-assert tests/test_helper/bats-file .gitmodules`

**Step 2: Create shared test helper (INFRA-02)**

Create `tests/test_helper/common-setup.bash` with:

```bash
#!/usr/bin/env bash
# tests/test_helper/common-setup.bash — Shared BATS test helper
# Loaded by every .bats file via: load 'test_helper/common-setup'

# Resolve PROJECT_ROOT reliably regardless of test file depth
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
export PROJECT_ROOT

_common_setup() {
    # Load assertion libraries
    # Dual-path: BATS_LIB_PATH (CI via bats-action) or submodules (local)
    if [[ -n "${BATS_LIB_PATH:-}" ]]; then
        bats_load_library bats-support
        bats_load_library bats-assert
        bats_load_library bats-file
    else
        load "${PROJECT_ROOT}/tests/test_helper/bats-support/load"
        load "${PROJECT_ROOT}/tests/test_helper/bats-assert/load"
        load "${PROJECT_ROOT}/tests/test_helper/bats-file/load"
    fi

    # Disable colors for predictable assertion matching
    export NO_COLOR=1
}
```

Key decisions:
- Use `git rev-parse --show-toplevel` for PROJECT_ROOT (works at any test file depth, per research open question #1)
- Dual-path loading: `BATS_LIB_PATH` for CI (bats-action sets this), submodule paths for local
- `NO_COLOR=1` suppresses ANSI codes so `assert_output` matches work reliably
- `_common_setup` is a function (BATS docs warn against `load`/`source` outside functions)
- Does NOT source `common.sh` globally -- individual tests do that when needed

**Step 3: Add Makefile targets (INFRA-03)**

Add `test` and `test-verbose` to the `.PHONY` declaration (append to existing line).

Add these targets after the `lint:` target:

```makefile
test: ## Run BATS test suite
	@./tests/bats/bin/bats tests/ --recursive --timing

test-verbose: ## Run BATS tests with verbose TAP output
	@./tests/bats/bin/bats tests/ --recursive --timing --verbose-run
```

Use `./tests/bats/bin/bats` (submodule binary) not system `bats` to ensure pinned version.

**Step 4: Update ShellCheck exclusions**

In the Makefile `lint:` target, add exclusions for BATS submodule `.sh` files. Update the `find` command to add:
- `-not -path './tests/bats/*'`
- `-not -path './tests/test_helper/bats-*/*'`

In `.github/workflows/shellcheck.yml`, add the same two exclusions to the `find` command.
  </action>
  <verify>
1. `ls tests/bats/bin/bats` -- binary exists
2. `./tests/bats/bin/bats --version` -- prints "Bats 1.13.0"
3. `ls tests/test_helper/common-setup.bash` -- helper exists
4. `ls tests/test_helper/bats-assert/load.bash` -- assert library exists
5. `ls tests/test_helper/bats-file/load.bash` -- file library exists
6. `grep -q 'test:' Makefile` -- test target exists
7. `grep -q 'test-verbose:' Makefile` -- test-verbose target exists
8. `grep -q 'tests/bats' Makefile` -- lint exclusion present
9. `grep -q 'tests/bats' .github/workflows/shellcheck.yml` -- CI exclusion present
10. `cat .gitmodules` -- shows 4 submodule entries
  </verify>
  <done>
BATS v1.13.0 and helper libraries installed as git submodules at pinned versions. Shared test helper exists at `tests/test_helper/common-setup.bash` with dual-path loading. Makefile has `test` and `test-verbose` targets using submodule binary. ShellCheck exclusions updated in both Makefile and CI workflow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create smoke test and verify full infrastructure with make test</name>
  <files>tests/smoke.bats</files>
  <action>
Create `tests/smoke.bats` with 5 `@test` blocks proving the infrastructure works:

```bash
#!/usr/bin/env bats
# tests/smoke.bats — Prove BATS infrastructure works with project's strict mode

setup() {
    load 'test_helper/common-setup'
    _common_setup
}

@test "BATS runs and assertions work" {
    run echo "hello world"
    assert_success
    assert_output "hello world"
}

@test "bats-file assertions work" {
    assert_file_exists "${PROJECT_ROOT}/Makefile"
}

@test "common.sh can be sourced without crashing BATS" {
    # Define show_help before sourcing (required by parse_common_args)
    show_help() { echo "test help"; }

    # Source all project libraries
    source "${PROJECT_ROOT}/scripts/common.sh"

    # CRITICAL: Disable strict mode and clear traps for BATS compatibility
    # Matches existing pattern in tests/test-arg-parsing.sh lines 187-188
    set +eEuo pipefail
    trap - ERR

    # Verify functions are available
    declare -F info
    declare -F require_cmd
    declare -F parse_common_args
    declare -F make_temp
}

@test "parse_common_args works after sourcing common.sh" {
    show_help() { echo "test help"; }
    source "${PROJECT_ROOT}/scripts/common.sh"
    set +eEuo pipefail
    trap - ERR

    # Reset state
    VERBOSE=0
    LOG_LEVEL="info"
    EXECUTE_MODE="show"
    REMAINING_ARGS=()

    parse_common_args -v scanme.nmap.org

    assert_equal "$EXECUTE_MODE" "show"
    (( VERBOSE >= 1 ))
    assert_equal "${REMAINING_ARGS[*]}" "scanme.nmap.org"
}

@test "run isolates script exit codes from BATS process" {
    run bash -c 'exit 42'
    assert_equal "$status" 42
}
```

Key details:
- `setup()` loads the shared helper and calls `_common_setup` (loads bats-assert, bats-file)
- Test 3 sources `common.sh` then immediately disables strict mode with `set +eEuo pipefail` and `trap - ERR` (proven pattern from `test-arg-parsing.sh`)
- `show_help()` must be defined before sourcing because `parse_common_args` calls it on `-h`
- Test 4 exercises `parse_common_args` to prove library functions work post-sourcing
- Test 5 proves `run` subshell isolation (scripts that `exit` don't kill BATS)

After creating the file, run:

```bash
make test
make test-verbose
```

Both must exit 0. `make test` shows TAP output with timing. `make test-verbose` shows per-test detail.

If any test crashes with BATS variable errors or trap conflicts, troubleshoot:
- Check if `set +eEuo pipefail` and `trap - ERR` are present after every `source common.sh`
- Check if EXIT trap from `cleanup.sh` causes issues (add `trap - EXIT` if needed)
  </action>
  <verify>
1. `make test` exits 0 with TAP output showing "5 tests, 0 failures"
2. `make test-verbose` exits 0 with per-test results and timing
3. `./tests/bats/bin/bats tests/smoke.bats` passes all 5 tests individually
  </verify>
  <done>
Smoke test at `tests/smoke.bats` passes all 5 tests: basic assertions, bats-file assertions, common.sh sourcing with strict mode handled, parse_common_args functionality, and run isolation. `make test` and `make test-verbose` both exit cleanly.
  </done>
</task>

</tasks>

<verification>
Run these commands to verify the full phase is complete:

1. `make test` — exits 0, TAP output shows "5 tests, 0 failures"
2. `make test-verbose` — exits 0, shows per-test names with timing
3. `make lint` — still passes (ShellCheck exclusions work)
4. `cat .gitmodules` — shows 4 submodule entries with correct URLs
5. `./tests/bats/bin/bats --version` — prints "Bats 1.13.0"
</verification>

<success_criteria>
1. `make test` runs BATS test suite and exits 0 with TAP output
2. `make test-verbose` shows per-test results with timing information
3. All 5 smoke tests pass, including the common.sh sourcing test that proves strict mode conflicts are handled
4. BATS helper libraries (bats-assert, bats-file) load successfully via shared test helper
5. ShellCheck linting still passes with BATS submodule files excluded
</success_criteria>

<output>
After completion, create `.planning/phases/18-bats-infrastructure/18-01-SUMMARY.md`
</output>
